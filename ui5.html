<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Taskcenter (OpenUI5)</title>
    <script id="sap-ui-bootstrap" src="https://ui5.sap.com/resources/sap-ui-core.js"
      data-sap-ui-theme="sap_horizon"
      data-sap-ui-compatVersion="edge"
      data-sap-ui-preload="async"
      data-sap-ui-libs="sap.m,sap.ui.unified,sap.f,sap.ui.layout"
      data-sap-ui-xx-waitForTheme="true">
    </script>
    <link rel="stylesheet" href="./assets/styles.css" />
    <style>
      html, body, #content { height: 100%; }
      .detail-panel {
        margin-bottom: 1rem;
        border-radius: 0.75rem;
        box-shadow: 0 8px 20px rgba(9, 30, 66, 0.1);
        overflow: hidden;
        border: 1px solid #d0dae6;
      }
      .detail-panel .sapMPanelContent {
        padding: 0.75rem 1rem 1rem 1rem;
        background: rgba(255, 255, 255, 0.96);
      }
      .detail-panel__icon {
        margin-right: 0.5rem;
        color: #0a6ed1;
      }
      .detail-panel__toolbar {
        background: linear-gradient(135deg, rgba(10, 110, 209, 0.1), rgba(10, 110, 209, 0));
        padding: 0.5rem 1rem;
      }
      .detail-description {
        line-height: 1.55;
        font-size: 0.95rem;
      }
      .detail-section img { max-width: 100%; height: auto; border-radius: 0.5rem; }
      .detail-summary {
        border-left: 4px solid #0a6ed1;
      }
      .detail-tokenizer {
        width: 100%;
      }
      .calendar-top {
        gap: 16px;
        margin-bottom: 1rem;
      }
      .calendar-box {
        min-width: 280px;
        max-width: 320px;
        background: rgba(255,255,255,0.95);
        border-radius: 0.75rem;
        box-shadow: 0 6px 18px rgba(9, 30, 66, 0.1);
        padding: 1rem;
        border: 1px solid #d0dae6;
      }
      .calendar-visual {
        min-height: 220px;
        background: linear-gradient(135deg, rgba(10,110,209,0.12), rgba(120, 164, 255, 0.08) 40%, rgba(255,255,255,0.95) 100%);
        border-radius: 0.75rem;
        position: relative;
        overflow: hidden;
        border: 1px solid rgba(13, 71, 161, 0.08);
      }
      .calendar-visual::after {
        content: "";
        position: absolute;
        top: -40px;
        right: -60px;
        width: 220px;
        height: 220px;
        background: radial-gradient(circle at center, rgba(10,110,209,0.2) 0%, rgba(10,110,209,0) 70%);
      }
      .calendar-visual__content {
        padding: 1.5rem;
        gap: 0.5rem;
        color: #0a1f44;
      }
      .calendar-visual__list {
        width: 100%;
      }
      .calendar-visual__list .sapMLIB {
        background: rgba(255,255,255,0.82);
        border-radius: 0.6rem;
        margin-bottom: 0.4rem;
        box-shadow: 0 4px 12px rgba(9, 30, 66, 0.08);
        padding: 0.5rem 0.85rem;
      }
      .calendar-visual__list .sapMLIB:last-child {
        margin-bottom: 0;
      }
      .calendar-visual__list-title {
        font-weight: 600;
      }
      .calendar-visual__list-sub {
        font-size: 0.85rem;
        color: #4f5d78;
      }
      .kanban {
        background: linear-gradient(135deg, rgba(241,245,255,0.95), rgba(229,240,255,0.9)), url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160' viewBox='0 0 160 160'%3E%3Ccircle cx='80' cy='80' r='60' fill='none' stroke='rgba(10,110,209,0.08)' stroke-width='2'/%3E%3Ccircle cx='10' cy='10' r='4' fill='rgba(10,110,209,0.08)'/%3E%3Ccircle cx='140' cy='140' r='6' fill='rgba(10,110,209,0.05)'/%3E%3C/svg%3E");
        background-size: cover;
        padding: 1.5rem;
        border-radius: 1rem;
        gap: 1rem;
      }
      .kanban-col {
        background: rgba(255,255,255,0.94);
        border-radius: 0.9rem;
        padding: 0.75rem;
        box-shadow: 0 12px 24px rgba(9, 30, 66, 0.12);
      }
      .kanban-col .sapMList {
        background: transparent;
      }
      .tab-decor {
        position: relative;
        overflow: hidden;
        background: linear-gradient(180deg, rgba(243,246,255,0.9) 0%, rgba(255,255,255,0.96) 70%);
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 10px 26px rgba(9, 30, 66, 0.08);
      }
      .tab-decor--updates::before,
      .tab-decor--guides::before,
      .tab-decor--events::before {
        content: "";
        display: block;
        width: 100%;
        height: 120px;
        border-radius: 0.8rem;
        margin-bottom: 1rem;
        background: linear-gradient(135deg, rgba(10,110,209,0.12), rgba(10,110,209,0));
      }
      .tab-decor--guides::before {
        background: linear-gradient(135deg, rgba(76,175,80,0.12), rgba(76,175,80,0));
      }
      .tab-decor--events::before {
        background: linear-gradient(135deg, rgba(255,143,0,0.14), rgba(255,143,0,0));
      }
      .role-selector {
        margin-top: 0.5rem;
      }
      .role-selector .sapMLIB {
        border-radius: 0.75rem;
        margin-bottom: 0.5rem;
        border: 1px solid transparent;
        transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
        box-shadow: 0 2px 8px rgba(9, 30, 66, 0.08);
        background: rgba(255,255,255,0.96);
        width: 100%;
        box-sizing: border-box;
        overflow: hidden;
      }
      .role-selector .sapMLIB:hover {
        border-color: #0a6ed1;
        box-shadow: 0 6px 16px rgba(9, 30, 66, 0.12);
        transform: translateY(-2px);
      }
      .role-selector .sapMLIB.sapMLIBSelected {
        border-color: #0a6ed1;
        box-shadow: 0 6px 18px rgba(10, 110, 209, 0.2);
      }
      .role-selector__item {
        align-items: center;
        gap: 1rem;
        padding: 0.75rem 1rem;
        width: 100%;
        box-sizing: border-box;
      }
      .role-selector__icon {
        color: #0a6ed1;
      }
      .role-selector__title {
        font-weight: 600;
        font-size: 1.05rem;
        color: #0a1f44;
      }
      .role-selector__desc {
        font-size: 0.9rem;
        color: #5f6b7a;
        margin-top: 0.25rem;
      }
      .app-header__logo {
        height: 32px;
        margin-right: 0.75rem;
      }
      .app-header__title {
        color: #0a1f44;
        font-weight: 600;
      }
    </style>
  </head>
  <body class="sapUiBody sapUiSizeCompact" id="content">
    <script src="./assets/config.js"></script>
    <script>
      window.addEventListener('error', function(e){
        try {
          const msg = (e.message||'').toString();
          console.error(e.error || msg);
          if (msg && msg !== 'Script error.') {
            sap.m && sap.m.MessageToast && sap.m.MessageToast.show('Fehler: '+ msg);
          }
        } catch(_){}
      });
      window.addEventListener('unhandledrejection', function(e){
        try {
          const reason = (e.reason && (e.reason.message||e.reason)) || 'Unbekannt';
          console.error('Unhandled rejection:', e.reason);
          sap.m && sap.m.MessageToast && sap.m.MessageToast.show('Fehler: '+ reason);
        } catch(_){}
      });
      sap.ui.getCore().attachInit(async function() {
        const api = (window.AppConfig && window.AppConfig.apiBaseUrl) || '';
        let isOfflineApi = false;
        let authToken = localStorage.getItem('demo_token') || '';
        let adminSettings = {};
        let bulkDeleteBtn;
        let list;
        const ROLE_METADATA = {
          lead: { key:'lead', label:'Filialleiter', description:'Plant Aufgaben und steuert das Team.', icon:'sap-icon://manager' },
          staff: { key:'staff', label:'Mitarbeiter', description:'Kann Aufgaben ausführen und kommentieren.', icon:'sap-icon://employee' },
          admin: { key:'admin', label:'Admin', description:'Hat exklusiven Zugriff auf den Admin-Bereich.', icon:'sap-icon://shield' }
        };
        const ROLE_OPTIONS = Object.keys(ROLE_METADATA);
        let storedRole = '';
        try { storedRole = localStorage.getItem('taskcenter_role') || ''; } catch(_){ storedRole = ''; }
        const initialRole = ROLE_OPTIONS.includes(storedRole) ? storedRole : '';

        const fmt = {
          overdue: function(dueAt){
            if (!dueAt) return false;
            try { return new Date(dueAt).getTime() < Date.now(); } catch(e){ return false; }
          },
          dueText: function(dueAt){
            if (!dueAt) return '';
            const d = new Date(dueAt);
            if (!Number.isFinite(d.getTime())) return '';
            return d.toLocaleString();
          },
          roleLabel: function(role){
            const meta = ROLE_METADATA[role];
            return meta ? meta.label : 'Rolle wählen';
          },
          prioState: function(p){ return p==='hoch' ? 'Error' : (p==='mittel' ? 'Warning' : 'Success'); },
          statusState: function(s){ return s==='abgeschlossen' ? 'Success' : (s==='in_arbeit' ? 'Information' : 'None'); },
          statusText: function(s){ if (s==='offen') return 'Offen'; if (s==='in_arbeit') return 'In Arbeit'; if (s==='abgeschlossen') return 'Abgeschlossen'; return s||''; },
          relative: function(ts){ try{ const d=new Date(ts); const diff=Date.now()-d.getTime(); const m=Math.floor(diff/60000); if (m<1) return 'gerade eben'; if (m<60) return `vor ${m} Min`; const h=Math.floor(m/60); if (h<24) return `vor ${h} Std`; const dd=Math.floor(h/24); return `vor ${dd} Tg`; }catch(_){ return ''; } },
          imageByMeta: function(priority, status, tags){
            // Try to pick a lightweight representative image URL
            try{
              if (priority && String(priority).toLowerCase()==='hoch') return 'https://images.unsplash.com/photo-1526948128573-703ee1aeb6fa?w=256&q=40&auto=format&fit=crop';
              if (status && String(status).toLowerCase()==='in_arbeit') return 'https://images.unsplash.com/photo-1519389950473-47ba0277781c?w=256&q=40&auto=format&fit=crop';
              const t = Array.isArray(tags)? tags.join(',').toLowerCase() : String(tags||'').toLowerCase();
              if (t.includes('marketing')||t.includes('promo')) return 'https://images.unsplash.com/photo-1512295767273-ac109ac3acfa?w=256&q=40&auto=format&fit=crop';
              if (t.includes('kalender')||t.includes('event')) return 'https://images.unsplash.com/photo-1511578314322-379afb476865?w=256&q=40&auto=format&fit=crop';
            }catch(_){/* ignore */}
            return 'https://images.unsplash.com/photo-1497366216548-37526070297c?w=256&q=40&auto=format&fit=crop';
          },
          processLabel: function(p){
            if (p==='we') return 'Wareneingang';
            if (p==='aktion') return 'Aktion';
            if (p==='frische') return 'Frische';
            if (p==='qm') return 'Qualitätsmeldung';
            if (p==='inventur') return 'Inventur';
            return p||'Prozess';
          },
          completionLabel: function(a){
            if (a==='POST_GR') return 'WE buchen';
            if (a==='CREATE_QM_NOTIFICATION') return 'QM-Meldung anlegen';
            if (a==='COMPLETE_PROMO') return 'Aktion abschließen';
            return 'Keine Buchung';
          }
        };

        function processToAction(proc){
          if (proc==='we') return 'POST_GR';
          if (proc==='qm') return 'CREATE_QM_NOTIFICATION';
          if (proc==='aktion') return 'COMPLETE_PROMO';
          return 'NONE';
        }

        function derivePriority(task){
          try{
            if (!task || task.processType!=='we') return task.priority || 'mittel';
            const type = (task.sourceDoc && task.sourceDoc.type) || '';
            const tagsText = Array.isArray(task.tags) ? task.tags.join(',').toLowerCase() : String(task.tags||'').toLowerCase();
            const isFresh = tagsText.includes('frische') || tagsText.includes('tk') || tagsText.includes('tiefkühl') || tagsText.includes('kühl');
            const due = task.dueAt ? new Date(task.dueAt) : null;
            const dueFuture = due && due.getTime() > Date.now();
            if (type==='STO'){ // Umlagerung: intern, direkt verräumen
              return isFresh ? 'hoch' : 'mittel';
            }
            if (type==='PROMO'){ // Aktion: bis Stichtag warten
              return dueFuture ? 'niedrig' : (isFresh ? 'mittel' : 'niedrig');
            }
            // Extern (PO/DELIVERY): prüfen und verbuchen über F1248, Fresh/TK sofort hohe Prio
            if (type==='PO' || type==='DELIVERY' || type===''){
              return isFresh ? 'hoch' : 'mittel';
            }
            return task.priority || 'mittel';
          }catch(_){ return task && task.priority || 'mittel'; }
        }

        function recomputePriorities(){
          try{
            const arr = (model.getProperty('/tasks')||[]).slice();
            arr.forEach(t=>{ if (t && t.processType==='we'){ t.priority = derivePriority(t); } });
            model.setProperty('/tasks', arr);
            computeAdminDerivations();
          }catch(e){ /* no-op */ }
        }

        function computeAdminDerivations(){
          try{
            const tasks = model.getProperty('/tasks') || [];
            const we = tasks.filter(t=> t && t.processType==='we');
            const kpis = { total: we.length, sto:0, external:0, promo:0, freshTk:0, postedOk:0, postedErr:0 };
            const now = Date.now();
            const top = [];
            const freshTag = (t)=>{ const s = Array.isArray(t.tags)? t.tags.join(',').toLowerCase(): String(t.tags||'').toLowerCase(); return s.includes('frische')||s.includes('tk')||s.includes('tiefkühl')||s.includes('kühl'); };
            const dayMs = 24*60*60*1000;
            const ages = { d0_1:0, d1_3:0, d3_7:0, d7p:0 };
            let throughputToday = 0; let totalCycleMs = 0; let cycleCount = 0;
            for (const t of we){
              const tp = (t.sourceDoc && t.sourceDoc.type) || '';
              if (tp==='STO') kpis.sto++; else if (tp==='PROMO') kpis.promo++; else kpis.external++;
              if (freshTag(t)) kpis.freshTk++;
              if (String(t.status)==='abgeschlossen' && String(t.lastPostStatus||'')==='success') kpis.postedOk++;
              if (String(t.lastPostStatus||'')==='error') kpis.postedErr++;
              const due = t.dueAt ? new Date(t.dueAt).getTime() : NaN;
              if (Number.isFinite(due) && due < now && String(t.status)!=='abgeschlossen') top.push(t);
              const base = Number.isFinite(due) ? due : (t.createdAt? Number(t.createdAt): NaN);
              if (Number.isFinite(base)){
                const ageDays = (now - base)/dayMs;
                if (ageDays <= 1) ages.d0_1++; else if (ageDays <= 3) ages.d1_3++; else if (ageDays <= 7) ages.d3_7++; else ages.d7p++;
              }
              if (t.completedAt){
                const d = new Date(t.completedAt);
                const isToday = d.toDateString() === new Date().toDateString();
                if (isToday) throughputToday++;
                const created = t.createdAt ? Number(t.createdAt) : NaN;
                if (Number.isFinite(created)) { totalCycleMs += (d.getTime() - created); cycleCount++; }
              }
            }
            top.sort((a,b)=> new Date(a.dueAt).getTime() - new Date(b.dueAt).getTime());
            const onlyFresh = !!model.getProperty('/adminFilters/weOnlyFresh');
            const topFiltered = onlyFresh ? top.filter(freshTag) : top;
            const derived = { weKPIs: kpis, topOverdueWE: topFiltered.slice(0,5), ageBuckets: ages, throughputToday, avgCycleTimeHours: cycleCount? Math.round((totalCycleMs/ cycleCount)/360000)/10 : 0 };
            model.setProperty('/adminDerived', derived);
          }catch(_){ /* ignore */ }
        }

        const model = new sap.ui.model.json.JSONModel({
          role: initialRole,
          isAuthenticated: Boolean(initialRole),
          canPlanTasks: initialRole === 'lead',
          canAccessAdmin: initialRole === 'admin',
          search: '',
          sort: 'created_desc',
          statusFilter: '',
          priorityFilter: '',
          tasks: [], updates: [], guides: [], events: [],
          tasksCount: 0, updatesCount: 0, guidesCount: 0, eventsCount: 0,
          notificationsCount: 0,
          tasksLabel: '',
          dashboard: {
            summary: { total:0, overdue:0, dueSoon:0, priority:{}, status:{}, tags:[] },
            tags: [],
            latest: [],
            generatedAt: ''
          },
          adminDerived: { weKPIs:{}, topOverdueWE:[], ageBuckets:{}, throughputToday:0, avgCycleTimeHours:0 },
          adminFilters: { weOnlyFresh:false }
        });

        function persistRole(role){
          try {
            if (role) { localStorage.setItem('taskcenter_role', role); }
            else { localStorage.removeItem('taskcenter_role'); }
          } catch(_){/* ignore */}
        }

        function updateRoleCapabilities(role){
          const isValid = ROLE_OPTIONS.includes(role);
          const normalized = isValid ? role : '';
          if (!isValid && role){
            model.setProperty('/role', normalized);
            return;
          }
          const authenticated = Boolean(normalized);
          if (model.getProperty('/isAuthenticated') !== authenticated){
            model.setProperty('/isAuthenticated', authenticated);
          }
          const canPlan = normalized === 'lead';
          if (model.getProperty('/canPlanTasks') !== canPlan){
            model.setProperty('/canPlanTasks', canPlan);
          }
          const canAccessAdmin = normalized === 'admin';
          if (model.getProperty('/canAccessAdmin') !== canAccessAdmin){
            model.setProperty('/canAccessAdmin', canAccessAdmin);
          }
          persistRole(normalized);
        }

        updateRoleCapabilities(initialRole);

        model.attachPropertyChange(function(ev){
          const path = ev.getParameter('path');
          if (path === '/role'){
            updateRoleCapabilities(ev.getSource().getProperty('/role'));
          }
          if (path === '/canPlanTasks'){
            if (typeof syncBulkDeleteVisibility === 'function') syncBulkDeleteVisibility();
            if (list && typeof updateBulkButtons === 'function') updateBulkButtons();
          }
          if (path === '/canAccessAdmin'){
            if (model.getProperty('/canAccessAdmin')){
              loadAdminOverview();
            } else {
              model.setProperty('/dashboard/summary', { total:0, overdue:0, dueSoon:0, priority:{}, status:{}, tags:[] });
              model.setProperty('/dashboard/tags', []);
              model.setProperty('/dashboard/latest', []);
              model.setProperty('/dashboard/generatedAt', '');
            }
          }
        });

        function openRoleSelectionDialog(opts){
          const options = opts || {};
          return new Promise((resolve)=>{
            let resolved = false;
            let dialog;
            const roleList = new sap.m.List({ mode:'SingleSelectMaster', includeItemInSelection:true, width:'100%' });
            roleList.addStyleClass('role-selector');
            ROLE_OPTIONS.forEach(roleKey=>{
              const meta = ROLE_METADATA[roleKey];
              const item = new sap.m.CustomListItem({
                type:'Active',
                selected: model.getProperty('/role') === roleKey,
                content: [
                  new sap.m.HBox({
                    alignItems:'Center',
                    width:'100%',
                    items:[
                      new sap.ui.core.Icon({ src: meta.icon, size:'2rem', decorative:false }).addStyleClass('role-selector__icon'),
                      new sap.m.VBox({
                        width:'100%',
                        items:[
                          new sap.m.Text({ text: meta.label }).addStyleClass('role-selector__title'),
                          new sap.m.Text({ text: meta.description }).addStyleClass('role-selector__desc')
                        ]
                      })
                    ]
                  }).addStyleClass('role-selector__item')
                ]
              });
              item.data('roleKey', roleKey);
              roleList.addItem(item);
              if (model.getProperty('/role') === roleKey){
                roleList.setSelectedItem(item, true);
              }
            });

            function chooseRole(roleKey){
              if (!ROLE_OPTIONS.includes(roleKey)) return;
              model.setProperty('/role', roleKey);
              updateRoleCapabilities(roleKey);
              resolved = true;
              if (dialog){ dialog.close(); }
              resolve(roleKey);
            }

            function handleSelection(item){
              if (!item) return;
              roleList.setSelectedItem(item, true);
              const roleKey = item.data('roleKey');
              chooseRole(roleKey);
            }

            roleList.attachSelectionChange(function(e){
              handleSelection(e.getParameter('listItem'));
            });
            roleList.attachItemPress(function(e){
              handleSelection(e.getParameter('listItem'));
            });

            const infoText = new sap.m.Text({ text:'Bitte eine Rolle auswählen. Die Auswahl bestimmt die verfügbaren Funktionen.' }).addStyleClass('sapUiSmallMarginBottom');
            const contentBox = new sap.m.VBox({ width:'100%', items:[ infoText, roleList ] }).addStyleClass('sapUiMediumMargin');

            dialog = new sap.m.Dialog({
              title:'Anmeldung – Rolle wählen',
              stretchOnPhone:true,
              contentWidth:'640px',
              horizontalScrolling:false,
              escapeHandler: function(oEvent){ if (options.force && !model.getProperty('/isAuthenticated')) { oEvent.preventDefault(); } else { dialog.close(); } }
            });

            if (!options.force){
              dialog.setEndButton(new sap.m.Button({ text:'Abbrechen', press:function(){ dialog.close(); resolve(null); } }));
            }

            dialog.addContent(contentBox);
            dialog.attachBeforeClose(function(e){
              if (options.force && !resolved && !model.getProperty('/isAuthenticated')){
                e.preventDefault();
                sap.m.MessageToast.show('Bitte eine Rolle auswählen, um fortzufahren.');
              }
            });
            dialog.attachAfterClose(function(){
              if (!resolved && options.force && !model.getProperty('/isAuthenticated')){
                resolve(null);
              }
              dialog.destroy();
            });
            dialog.open();
          });
        }

        async function ensureAuthenticated(){
          if (model.getProperty('/isAuthenticated')) return;
          while (!model.getProperty('/isAuthenticated')){
            await openRoleSelectionDialog({ force:true });
          }
        }

        const busy = new sap.m.BusyDialog();
        let chipBar; // declared early to avoid TDZ when updateFilterSummary runs before toolbar init
        let needInitialFilterSummary = false;
        // Load admin settings
        try{ adminSettings = JSON.parse(localStorage.getItem('admin_settings')||'{}'); }catch(_){ adminSettings = {}; }
        async function loadAdminOverview(){
          if (!authToken || !model.getProperty('/canAccessAdmin')) return;
          try {
            const resp = await fetch(api + '/admin/overview', { headers: authHeaders() });
            if (!resp.ok) throw new Error('Admin Überblick fehlgeschlagen');
            const json = await resp.json();
            model.setProperty('/dashboard/summary', json.summary || {});
            model.setProperty('/dashboard/tags', json.tags || []);
            model.setProperty('/dashboard/latest', json.latestTasks || []);
            model.setProperty('/dashboard/generatedAt', json.generatedAt || '');
          } catch(err){ console.warn(err); }
        }

        async function loadAll(){
          busy.open();
          try {
            if (!api) { throw new Error('API nicht konfiguriert'); }
            const [tasksResp, updatesResp, guidesResp, eventsResp] = await Promise.all([
              fetch(api + '/tasks'),
              fetch(api + '/updates'),
              fetch(api + '/guides'),
              fetch(api + '/events')
            ]);
            if (!tasksResp.ok || !updatesResp.ok || !guidesResp.ok || !eventsResp.ok) {
              throw new Error('API antwortet nicht wie erwartet');
            }
            const [tasks, updates, guides, events] = await Promise.all([
              tasksResp.json(),
              updatesResp.json(),
              guidesResp.json(),
              eventsResp.json()
            ]);
            if (tasks && tasks.items) {
              model.setProperty('/tasks', tasks.items);
              model.setProperty('/tasksTotal', tasks.total||tasks.items.length);
              model.setProperty('/tasksCount', tasks.items.length);
              if (tasks.summary) model.setProperty('/dashboard/summary', tasks.summary);
              if (tasks.tags) model.setProperty('/dashboard/tags', tasks.tags);
              if (tasks.pageSummary) model.setProperty('/dashboard/pageSummary', tasks.pageSummary);
            }
            else {
              const arr = Array.isArray(tasks)? tasks : (tasks||[]);
              model.setProperty('/tasks', arr);
              model.setProperty('/tasksTotal', arr.length);
              model.setProperty('/tasksCount', arr.length);
            }
            model.setProperty('/tasksLabel', 'Aufgaben: ' + model.getProperty('/tasksCount') + (model.getProperty('/tasksTotal') ? (' / ' + model.getProperty('/tasksTotal')) : ''));
            model.setProperty('/updates', updates); model.setProperty('/updatesCount', Array.isArray(updates)? updates.length : (updates.items?updates.items.length:0));
            model.setProperty('/guides', guides); model.setProperty('/guidesCount', Array.isArray(guides)? guides.length : (guides.items?guides.items.length:0));
            model.setProperty('/events', events); model.setProperty('/eventsCount', Array.isArray(events)? events.length : (events.items?events.items.length:0));
            isOfflineApi = false;
            model.setProperty('/syncState', { offline:false, message:'' });
          } catch(e){
            console.warn('Server nicht erreichbar, verwende Demo-Daten.', e);
            const sd = window.APP_DATA || {};
            if (sd.tasks) {
              model.setProperty('/tasks', sd.tasks);
              model.setProperty('/tasksTotal', sd.tasks.length);
              model.setProperty('/tasksCount', sd.tasks.length);
            }
            model.setProperty('/updates', sd.updates || []); model.setProperty('/updatesCount', (sd.updates||[]).length);
            model.setProperty('/guides', sd.guides || []); model.setProperty('/guidesCount', (sd.guides||[]).length);
            model.setProperty('/events', sd.events || []); model.setProperty('/eventsCount', (sd.events||[]).length);
            isOfflineApi = true;
            model.setProperty('/syncState', { offline:true, message:'Demo-Daten aktiv – Backend nicht erreichbar.' });
          } finally { busy.close(); }
        }
        await ensureAuthenticated();
        await loadAll();
        recomputePriorities();
        await loadAdminOverview();
        needInitialFilterSummary = true;
        // polling for new updates/events (configurable)
        let lastUpdateCount = Array.isArray(model.getProperty('/updates')) ? model.getProperty('/updates').length : 0;
        let lastEventCount = Array.isArray(model.getProperty('/events')) ? model.getProperty('/events').length : 0;
        let notifyIntervalId = null;
        async function pollNotifications(){
          if (isOfflineApi || !api) { return; }
          try{
            const [u, e] = await Promise.all([
              fetch(api + '/updates').then(r=>r.json()),
              fetch(api + '/events').then(r=>r.json())
            ]);
            const uLen = Array.isArray(u)?u.length:(u.items?u.items.length:0);
            const eLen = Array.isArray(e)?e.length:(e.items?e.items.length:0);
            if (uLen > lastUpdateCount) {
              model.setProperty('/updates', Array.isArray(u)?u:(u.items||[]));
              const inc = (uLen - lastUpdateCount);
              model.setProperty('/notificationsCount', (model.getProperty('/notificationsCount')||0) + inc);
              sap.m.MessageToast.show(`${inc} neue Updates`);
              lastUpdateCount = uLen;
            }
            if (eLen > lastEventCount) {
              model.setProperty('/events', Array.isArray(e)?e:(e.items||[]));
              const inc = (eLen - lastEventCount);
              model.setProperty('/notificationsCount', (model.getProperty('/notificationsCount')||0) + inc);
              sap.m.MessageToast.show(`${inc} neue Events`);
              lastEventCount = eLen;
            }
          }catch(_){/* ignore */}
        }
        function startNotifyInterval(ms){
          if (notifyIntervalId) { clearInterval(notifyIntervalId); notifyIntervalId = null; }
          const interval = Math.max(15000, Number(ms)||60000);
          if (!isOfflineApi && api) {
            notifyIntervalId = setInterval(pollNotifications, interval);
          }
        }

        function authHeaders(){ const h={'Content-Type':'application/json'}; if (authToken) h['Authorization'] = 'Bearer '+authToken; return h; }
        async function fetchComments(taskId){
          if (isOfflineApi || !api) { return []; }
          try{
            const r = await fetch(api + '/tasks/' + taskId + '/comments');
            return await r.json();
          }catch(e){ console.error(e); return []; }
        }
        async function postComment(taskId, text){
          if (isOfflineApi || !api) { sap.m.MessageToast.show('Kommentare im Demo-Modus deaktiviert'); return null; }
          try{
            const r = await fetch(api + '/tasks/' + taskId + '/comments', { method:'POST', headers: authHeaders(), body: JSON.stringify({ text, author: (model.getProperty('/role')==='lead'?'Leitung':'Mitarbeiter') }) });
            return await r.json();
          }catch(e){ console.error(e); sap.m.MessageToast.show('Kommentar speichern fehlgeschlagen'); return null; }
        }
        function openTokenDialog(){
          try {
            var input = new sap.m.Input({ value: authToken || '', placeholder:'demo-token' });
            var d = new sap.m.Dialog({ title:'Auth Token', content:[ input ], beginButton: new sap.m.Button({ text:'Speichern', type:'Emphasized', press: function(){ authToken = input.getValue(); try{ localStorage.setItem('demo_token', authToken); }catch(_){} d.close(); sap.m.MessageToast.show('Token gespeichert'); } }), endButton: new sap.m.Button({ text:'Abbrechen', press: function(){ d.close(); } }) });
            d.open();
          } catch(e) { console.error(e); }
        }
        async function createTask(payload){
          if (isOfflineApi || !api) {
            const arr = model.getProperty('/tasks').slice();
            const tmp = Object.assign({ id: Date.now(), status:'offen', createdAt: Date.now() }, payload);
            arr.unshift(tmp);
            model.setProperty('/tasks', arr);
            sap.m.MessageToast.show('Demo: Aufgabe lokal hinzugefügt');
            recomputePriorities();
            return;
          }
          const r = await fetch(api + '/tasks', { method:'POST', headers: authHeaders(), body: JSON.stringify(payload)});
          const t = await r.json();
          const arr = model.getProperty('/tasks').slice(); arr.unshift(t); model.setProperty('/tasks', arr);
          sap.m.MessageToast.show('Aufgabe erstellt');
          recomputePriorities();
        }
        async function updateTask(id, payload){
          const arr = model.getProperty('/tasks').slice();
          const idx = arr.findIndex(x=> String(x && x.id) === String(id));
          let updatedTask = null;
          try {
            if (isOfflineApi || !api) { throw new Error('Offline-Modus aktiv'); }
            const resp = await fetch(api + '/tasks/' + id, { method:'PUT', headers: authHeaders(), body: JSON.stringify(payload)});
            if (!resp.ok) throw new Error('Update fehlgeschlagen: ' + resp.status);
            updatedTask = await resp.json();
          } catch(err){
            console.warn('Remote update failed, applying local update.', err);
            if (idx>-1) {
              updatedTask = Object.assign({}, arr[idx], payload);
            }
          }
          if (!updatedTask) {
            sap.m.MessageToast.show('Aufgabe konnte nicht gespeichert werden');
            return;
          }
          const targetIdx = arr.findIndex(x=> String(x && x.id) === String(updatedTask && updatedTask.id || id));
          if (targetIdx>-1) {
            arr[targetIdx] = Object.assign({}, arr[targetIdx], updatedTask);
            model.setProperty('/tasks', arr);
          } else {
            model.setProperty('/tasks', arr.concat(updatedTask));
          }
          sap.m.MessageToast.show('Aufgabe gespeichert');
          recomputePriorities();
        }
        async function deleteTask(id){
          if (isOfflineApi || !api) {
            const arr = model.getProperty('/tasks').slice().filter(x=>String(x.id)!==String(id));
            model.setProperty('/tasks', arr);
            sap.m.MessageToast.show('Demo: Aufgabe lokal entfernt');
            return;
          }
          await fetch(api + '/tasks/' + id, { method:'DELETE', headers: authHeaders() });
          const arr = model.getProperty('/tasks').slice().filter(x=>x.id!==id); model.setProperty('/tasks', arr);
          sap.m.MessageToast.show('Aufgabe gelöscht');
        }

        async function mockCompleteTask(task){
          try{
            const proc = (task && task.processType) || '';
            const action = (task && task.completionAction) || processToAction(proc);
            const docType = task && task.sourceDoc && task.sourceDoc.type || '';
            const docId = task && task.sourceDoc && task.sourceDoc.id || '';
            const dialogInfo = new sap.m.VBox({ width:'100%', items:[
              new sap.m.ObjectStatus({ text:'Prozess: ' + (fmt.processLabel(proc)||'–'), icon:'sap-icon://process', state:'None' }),
              new sap.m.ObjectStatus({ text:'Beleg: ' + (docType||'–') + (docId? (' • ' + docId):''), icon:'sap-icon://document', state:'None' }),
              new sap.m.ObjectStatus({ text:'Aktion: ' + fmt.completionLabel(action), icon:'sap-icon://accept', state:'Information' })
            ]});
            const confirmDlg = new sap.m.Dialog({ title:'Vorgang abschließen', type:'Message', content:[ dialogInfo ], beginButton: new sap.m.Button({ text:'Ausführen (Mock)', type:'Emphasized', press: async ()=>{
              confirmDlg.close();
              busy.open();
              try{
                await updateTask(task.id, { status:'abgeschlossen', completedAt: new Date().toISOString(), lastPostStatus:'success', lastPostMessage:'Mock: ' + fmt.completionLabel(action) });
                sap.m.MessageToast.show('Vorgang abgeschlossen (Mock)');
              } finally { busy.close(); }
            } }), endButton: new sap.m.Button({ text:'Abbrechen', press: ()=> confirmDlg.close() }) });
            confirmDlg.open();
          }catch(e){ console.error(e); sap.m.MessageToast.show('Abschluss fehlgeschlagen (Mock)'); }
        }

        function taskSorter(){
          const sort = model.getProperty('/sort');
          if (sort==='created_asc') return [ new sap.ui.model.Sorter('createdAt', false) ];
          if (sort==='priority_desc') return [ new sap.ui.model.Sorter('priority', true) ];
          if (sort==='priority_asc') return [ new sap.ui.model.Sorter('priority', false) ];
          return [ new sap.ui.model.Sorter('createdAt', true) ];
        }

        const app = new sap.m.App();
        const notifyDlgModel = new sap.ui.model.json.JSONModel({ items: [] });
        const notifyDlg = new sap.m.Dialog({ title:'Neuigkeiten', contentWidth:'600px', content:[
          new sap.m.List({ items:{ path:'n>/items', template: new sap.m.StandardListItem({ title:'{n>title}', description:'{n>content}', info:'{n>date}' }) } })
        ], endButton: new sap.m.Button({ text:'Schließen', press: ()=> notifyDlg.close() }) });
        notifyDlg.setModel(notifyDlgModel, 'n');
        function openNotify(){
          const items = (model.getProperty('/updates')||[]).slice(0,10);
          notifyDlgModel.setProperty('/items', items);
          model.setProperty('/notificationsCount', 0);
          notifyDlg.open();
        }
        function toggleTheme(){
          try{
            const cur = sap.ui.getCore().getConfiguration().getTheme();
            const next = cur && cur.toLowerCase().includes('dark') ? 'sap_horizon' : 'sap_horizon_dark';
            sap.ui.getCore().applyTheme(next);
            sap.m.MessageToast.show('Theme: ' + next);
          }catch(e){ console.error(e); }
        }
        function openAdminDialog(){
          const s = Object.assign({ theme: (adminSettings.theme||''), role: model.getProperty('/role')||'lead', pageSize: model.getProperty('/tasksPageSize')||10, compact: document.body.classList.contains('sapUiSizeCompact'), notifyMs: adminSettings.notifyMs || 60000 }, adminSettings);
          const themeSel = new sap.m.Select({ selectedKey: s.theme||'', items:[
            new sap.ui.core.Item({ key:'', text:'Standard' }),
            new sap.ui.core.Item({ key:'sap_horizon', text:'Hell (Horizon)' }),
            new sap.ui.core.Item({ key:'sap_horizon_dark', text:'Dunkel (Horizon)' })
          ]});
          const roleSel = new sap.m.Select({ selectedKey: s.role, items:[ new sap.ui.core.Item({ key:'lead', text:'Leitung' }), new sap.ui.core.Item({ key:'staff', text:'Mitarbeiter' }) ]});
          const sizeSel = new sap.m.Select({ selectedKey: String(s.pageSize), items:[ new sap.ui.core.Item({ key:'5', text:'5' }), new sap.ui.core.Item({ key:'10', text:'10' }), new sap.ui.core.Item({ key:'20', text:'20' }), new sap.ui.core.Item({ key:'50', text:'50' }) ]});
          const compactChk = new sap.m.CheckBox({ selected: !!s.compact, text:'Kompakte Dichte (sapUiSizeCompact)' });
          const notifSel = new sap.m.Select({ selectedKey: String(s.notifyMs||60000), items:[ new sap.ui.core.Item({ key:'30000', text:'30 Sek.' }), new sap.ui.core.Item({ key:'60000', text:'60 Sek.' }), new sap.ui.core.Item({ key:'120000', text:'120 Sek.' }) ]});
          const form = new sap.ui.layout.form.SimpleForm({ editable:true, layout:'ResponsiveGridLayout', labelSpanL:3, content:[
            new sap.m.Label({ text:'Theme' }), themeSel,
            new sap.m.Label({ text:'Rolle' }), roleSel,
            new sap.m.Label({ text:'Default Seitegröße' }), sizeSel,
            new sap.m.Label({ text:'Anzeige' }), compactChk,
            new sap.m.Label({ text:'Benachrichtigungen' }), notifSel
          ]});
          const d = new sap.m.Dialog({ contentWidth:'520px', customHeader: new sap.m.Bar({ contentLeft:[ new sap.ui.core.Icon({ src:'sap-icon://action-settings' }), new sap.m.Title({ text:'Admin & Einstellungen' }) ] }), content:[ form ], beginButton: new sap.m.Button({ text:'Speichern', type:'Emphasized', press: ()=>{
            const newTheme = themeSel.getSelectedKey(); if (newTheme) { try{ sap.ui.getCore().applyTheme(newTheme); }catch(_){}}
            model.setProperty('/role', roleSel.getSelectedKey());
            model.setProperty('/tasksPageSize', Number(sizeSel.getSelectedKey()));
            if (compactChk.getSelected()){ document.body.classList.add('sapUiSizeCompact'); } else { document.body.classList.remove('sapUiSizeCompact'); }
            const nm = Number(notifSel.getSelectedKey()); startNotifyInterval(nm);
            adminSettings = { theme:newTheme, notifyMs:nm };
            try{ localStorage.setItem('admin_settings', JSON.stringify(adminSettings)); }catch(_){}
            d.close();
          } }), endButton: new sap.m.Button({ text:'Abbrechen', press: ()=> d.close() }) });
          d.open();
        }
        const headerBar = new sap.m.Bar({
          contentLeft: [
            new sap.m.HBox({
              alignItems:'Center',
              items:[
                new sap.m.Image({ src:'https://realcore.info/bilder/rc-logo.png', decorative:false, tooltip:'RealCore', densityAware:false }).addStyleClass('app-header__logo'),
                new sap.m.VBox({
                  items:[ new sap.m.Title({ text:'Taskcenter (OpenUI5)' }).addStyleClass('app-header__title') ]
                })
              ]
            })
          ],
          contentRight: [
            new sap.m.Button({ icon:'sap-icon://bell', tooltip:'Neuigkeiten', press: openNotify }),
            new sap.m.Button({ icon:'sap-icon://palette', tooltip:'Theme wechseln', press: toggleTheme }),
            new sap.m.Button({ icon:'sap-icon://action-settings', tooltip:'Admin & Einstellungen', press: openAdminDialog }),
            new sap.m.Button({ text:'Token', icon:'sap-icon://key', press: openTokenDialog })
          ]
        });
        const page = new sap.m.Page({ customHeader: headerBar });

        // Toolbar
        // Tasks server-side query state
        model.setProperty('/tasksPage', 1);
        model.setProperty('/tasksPageSize', 10);
        model.setProperty('/tasksTotal', 0);
        model.setProperty('/tagsFilter', '');
        model.setProperty('/countOffen', 0);
        model.setProperty('/countInArbeit', 0);
        model.setProperty('/countAbgeschlossen', 0);
        model.setProperty('/countOverdue', 0);
        // restore saved view
        try{
          const saved = JSON.parse(localStorage.getItem('tasks_view')||'null');
          if (saved && typeof saved==='object'){
            ['search','statusFilter','priorityFilter','tagsFilter','sort','tasksPage','tasksPageSize'].forEach(k=>{
              if (saved[k]!==undefined) model.setProperty('/'+k, saved[k]);
            });
          }
        }catch(_){/* ignore */}
        function saveView(){
          const v = {
            search: model.getProperty('/search')||'',
            statusFilter: model.getProperty('/statusFilter')||'',
            priorityFilter: model.getProperty('/priorityFilter')||'',
            tagsFilter: model.getProperty('/tagsFilter')||'',
            sort: model.getProperty('/sort')||'created_desc',
            tasksPage: model.getProperty('/tasksPage')||1,
            tasksPageSize: model.getProperty('/tasksPageSize')||10
          };
          try{ localStorage.setItem('tasks_view', JSON.stringify(v)); }catch(_){ }
        }
        async function loadTasks(){
          const q = encodeURIComponent(model.getProperty('/search')||'');
          const status = encodeURIComponent(model.getProperty('/statusFilter')||'');
          const prio = encodeURIComponent(model.getProperty('/priorityFilter')||'');
          const sort = encodeURIComponent(model.getProperty('/sort')||'created_desc');
          const tags = encodeURIComponent(model.getProperty('/tagsFilter')||'');
          const page = Number(model.getProperty('/tasksPage')||1);
          const pageSize = Number(model.getProperty('/tasksPageSize')||10);
          const url = `${api}/tasks?page=${page}&pageSize=${pageSize}` + (q?`&q=${q}`:'') + (status?`&status=${status}`:'') + (prio?`&priority=${prio}`:'') + (tags?`&tags=${tags}`:'') + (sort?`&sort=${sort}`:'');
          try {
            list.setBusy(true);
            const resp = await fetch(url);
            const json = await resp.json();
            const items = json.items || [];
            model.setProperty('/tasks', items);
            model.setProperty('/tasksTotal', json.total || items.length);
            model.setProperty('/tasksCount', items.length);
            if (json.summary) model.setProperty('/dashboard/summary', json.summary);
            if (json.pageSummary) model.setProperty('/dashboard/pageSummary', json.pageSummary);
            if (json.tags) model.setProperty('/dashboard/tags', json.tags);
            model.setProperty('/tasksLabel', 'Aufgaben: ' + model.getProperty('/tasksCount') + (model.getProperty('/tasksTotal') ? (' / ' + model.getProperty('/tasksTotal')) : ''));
            // page-level stats
            let offen=0, inArb=0, abg=0, over=0; const now=Date.now();
            items.forEach(t=>{ if (t.status==='offen') offen++; else if (t.status==='in_arbeit') inArb++; else if (t.status==='abgeschlossen') abg++; const d=t.dueAt? Date.parse(t.dueAt):0; if (d && d<now && t.status!=='abgeschlossen') over++; });
            model.setProperty('/countOffen', offen);
            model.setProperty('/countInArbeit', inArb);
            model.setProperty('/countAbgeschlossen', abg);
            model.setProperty('/countOverdue', over);
          } finally { list.setBusy(false); }
          saveView();
        }
        const search = new sap.m.SearchField({ width: '100%', liveChange: async e=>{ model.setProperty('/search', e.getSource().getValue()); model.setProperty('/tasksPage', 1); updateFilterSummary(); await loadTasks(); } });
        const sortSelect = new sap.m.Select({ width:'12rem', selectedKey:'{/sort}', change: async e=>{ model.setProperty('/sort', e.getSource().getSelectedKey()); model.setProperty('/tasksPage', 1); updateFilterSummary(); await loadTasks(); }, items:[
          new sap.ui.core.Item({ key:'created_desc', text:'Neueste zuerst' }),
          new sap.ui.core.Item({ key:'created_asc', text:'Älteste zuerst' }),
          new sap.ui.core.Item({ key:'priority_desc', text:'Prio hoch → niedrig' }),
          new sap.ui.core.Item({ key:'priority_asc', text:'Prio niedrig → hoch' })
        ]});
        const statusSel = new sap.m.Select({ width:'10rem', change: async e=>{ model.setProperty('/statusFilter', e.getSource().getSelectedKey()); model.setProperty('/tasksPage', 1); updateFilterSummary(); await loadTasks(); }, items:[
          new sap.ui.core.Item({ key:'', text:'Status: Alle' }),
          new sap.ui.core.Item({ key:'offen', text:'Offen' }),
          new sap.ui.core.Item({ key:'in_arbeit', text:'In Arbeit' }),
          new sap.ui.core.Item({ key:'abgeschlossen', text:'Abgeschlossen' })
        ]});
        const prioSel = new sap.m.Select({ width:'10rem', change: async e=>{ model.setProperty('/priorityFilter', e.getSource().getSelectedKey()); model.setProperty('/tasksPage', 1); updateFilterSummary(); await loadTasks(); }, items:[
          new sap.ui.core.Item({ key:'', text:'Prio: Alle' }),
          new sap.ui.core.Item({ key:'hoch', text:'Hoch' }),
          new sap.ui.core.Item({ key:'mittel', text:'Mittel' }),
          new sap.ui.core.Item({ key:'niedrig', text:'Niedrig' })
        ]});
        const roleBtn = new sap.m.Button({
          text: { path:'/role', formatter: function(r){ return 'Rolle: ' + fmt.roleLabel(r); } },
          icon: { path:'/role', formatter:function(r){ const meta = ROLE_METADATA[r]; return meta ? meta.icon : 'sap-icon://customer'; } },
          type:'Transparent',
          press: ()=>{ openRoleSelectionDialog(); }
        });
        const addBtn = new sap.m.Button({ text:'Neue Aufgabe', type:'Emphasized', press: openCreateDialog, enabled:'{/canPlanTasks}' });

        // Bulk action buttons
        const bulkCompleteBtn = new sap.m.Button({ text:'Ausgewählte erledigen', icon:'sap-icon://accept', press: onBulkComplete, enabled:false });
        bulkDeleteBtn = new sap.m.Button({ text:'Ausgewählte löschen', icon:'sap-icon://delete', type:'Reject', press: onBulkDelete, enabled:false });
        function syncBulkDeleteVisibility(){ bulkDeleteBtn.setVisible(Boolean(model.getProperty('/canPlanTasks'))); }
        syncBulkDeleteVisibility();
        const exportBtn = new sap.m.Button({ text:'Export', icon:'sap-icon://export', press: onExport });
        const importUploader = new sap.ui.unified.FileUploader({ icon:'sap-icon://upload', buttonOnly:true, sameFilenameAllowed:true, fileType:['json'], change:onImportChange });

        // Filter summary (updates on filter changes)
        model.setProperty('/filterSummary', '');
        // chips bar for active filters
        chipBar = chipBar || null;
        function rebuildChips(parts){
          if (!chipBar) return;
          const chips = [];
          function mkChip(label, onClear){ return new sap.m.Button({ text: label, icon:'sap-icon://decline', type:'Transparent', press:onClear }); }
          const s = model.getProperty('/search'); if (s) chips.push(mkChip('Suche: "'+s+'"', async ()=>{ model.setProperty('/search',''); await loadTasks(); updateFilterSummary(); }));
          const st = model.getProperty('/statusFilter'); if (st) chips.push(mkChip('Status: '+(st==='offen'?'Offen':st==='in_arbeit'?'In Arbeit':'Abgeschlossen'), async ()=>{ model.setProperty('/statusFilter',''); await loadTasks(); updateFilterSummary(); }));
          const p = model.getProperty('/priorityFilter'); if (p) chips.push(mkChip('Prio: '+(p.charAt(0).toUpperCase()+p.slice(1)), async ()=>{ model.setProperty('/priorityFilter',''); await loadTasks(); updateFilterSummary(); }));
          const tg = model.getProperty('/tagsFilter'); if (tg) chips.push(mkChip('Tags: '+tg, async ()=>{ model.setProperty('/tagsFilter',''); await loadTasks(); updateFilterSummary(); }));
          chipBar.removeAllContent();
          if (chips.length){ chips.forEach(c=> chipBar.addContent(c)); chipBar.setVisible(true); }
          else { chipBar.setVisible(false); }
        }
        function updateFilterSummary(){
          const parts = [];
          const s = model.getProperty('/search'); if (s) parts.push('Suche: "'+s+'"');
          const st = model.getProperty('/statusFilter'); if (st) parts.push('Status: '+(st==='offen'?'Offen':st==='in_arbeit'?'In Arbeit':'Abgeschlossen'));
          const p = model.getProperty('/priorityFilter'); if (p) parts.push('Prio: '+(p.charAt(0).toUpperCase()+p.slice(1)));
          const tg = model.getProperty('/tagsFilter'); if (tg) parts.push('Tags: '+tg);
          model.setProperty('/filterSummary', parts.join('  •  '));
          rebuildChips(parts);
        }
        const summaryText = new sap.m.Text({ text: '{/tasksLabel}' });
        const filterText = new sap.m.Text({ text: '{/filterSummary}' });
        const tagsInput = new sap.m.Input({ width:'16rem', placeholder:'Tags (csv)', value:'{/tagsFilter}', change: async (e)=>{ model.setProperty('/tagsFilter', e.getSource().getValue()); model.setProperty('/tasksPage', 1); updateFilterSummary(); await loadTasks(); } });
        const resetFiltersBtn = new sap.m.Button({ text:'Zurücksetzen', type:'Transparent', press: async ()=>{
          model.setProperty('/search','');
          model.setProperty('/statusFilter','');
          model.setProperty('/priorityFilter','');
          model.setProperty('/tagsFilter','');
          model.setProperty('/sort','created_desc');
          model.setProperty('/tasksPage',1);
          updateFilterSummary();
          await loadTasks();
        }});
        const quickStatus = new sap.m.SegmentedButton({ width:'auto', items:[
          new sap.m.SegmentedButtonItem({ key:'', text:'Alle' }),
          new sap.m.SegmentedButtonItem({ key:'offen', text:'Offen' }),
          new sap.m.SegmentedButtonItem({ key:'in_arbeit', text:'In Arbeit' }),
          new sap.m.SegmentedButtonItem({ key:'abgeschlossen', text:'Abgeschlossen' })
        ], selectionChange: async (e)=>{ model.setProperty('/statusFilter', e.getParameter('item').getKey()); model.setProperty('/tasksPage', 1); updateFilterSummary(); await loadTasks(); }});
        const prioLegend = new sap.m.Toolbar({ content:[
          new sap.m.ObjectStatus({ text:'Prio Hoch', state:'Error' }),
          new sap.m.ToolbarSeparator(),
          new sap.m.ObjectStatus({ text:'Prio Mittel', state:'Warning' }),
          new sap.m.ToolbarSeparator(),
          new sap.m.ObjectStatus({ text:'Prio Niedrig', state:'Success' })
        ]});
        if (!chipBar) { chipBar = new sap.m.Toolbar({ visible:false, content:[] }); }
        const toolbar = new sap.m.Toolbar({ content:[
          new sap.m.ToolbarSpacer(),
          search,
          new sap.m.ToolbarSeparator(),
          sortSelect,
          statusSel,
          quickStatus,
          prioSel,
          tagsInput,
          resetFiltersBtn,
          new sap.m.ToolbarSeparator(),
          summaryText,
          new sap.m.Text({ text:'  ' }),
          filterText,
          new sap.m.ToolbarSpacer(),
          bulkCompleteBtn,
          bulkDeleteBtn,
          exportBtn,
          importUploader,
          new sap.m.ToolbarSeparator(),
          roleBtn,
          addBtn
        ]});
        if (needInitialFilterSummary) { updateFilterSummary(); needInitialFilterSummary = false; }

        // List & binding with formatter and filters
        list = new sap.m.List({ inset:false, mode:'MultiSelect', growing:true, growingScrollToLoad:true, selectionChange:updateBulkButtons });
        list.setNoDataText('Keine Aufgaben gefunden. Mit "Neue Aufgabe" kannst du starten.');
        const itemTpl = new sap.m.ObjectListItem({
          title: '{title}',
          icon: { parts:['priority','status','tags'], formatter: fmt.imageByMeta },
          iconDensityAware:false,
          number: { path: 'dueAt', formatter: fmt.dueText },
          numberState: { path: 'dueAt', formatter: function(d){ return fmt.overdue(d)? 'Error' : 'None'; } },
          firstStatus: new sap.m.ObjectStatus({ text: '{priority}', state: { path:'priority', formatter: fmt.prioState } }),
          secondStatus: new sap.m.ObjectStatus({ text: { path:'status', formatter: fmt.statusText }, state: { path:'status', formatter: fmt.statusState } }),
          type: 'Active'
        });
        list.bindItems({ path:'/tasks', template: itemTpl });

        // remove client-side filters; server does it

        list.attachItemPress(async function(ev){
          if (!model.getProperty('/isAuthenticated')){
            await ensureAuthenticated();
            if (!model.getProperty('/isAuthenticated')) return;
          }
          const ctx = ev.getParameter('listItem').getBindingContext();
          const t = ctx.getObject();
          openEditDialog(t);
        });

        function updateBulkButtons(){
          const sel = list.getSelectedItems();
          bulkCompleteBtn.setEnabled(sel.length>0);
          bulkDeleteBtn.setEnabled(sel.length>0 && model.getProperty('/canPlanTasks'));
        }

        async function onBulkComplete(){
          const sel = list.getSelectedItems();
          for (const it of sel){ const t = it.getBindingContext().getObject(); await updateTask(t.id, { status:'abgeschlossen' }); }
          list.removeSelections(true); updateBulkButtons();
          sap.m.MessageToast.show('Ausgewählte Aufgaben erledigt');
        }
        async function onBulkDelete(){
          const sel = list.getSelectedItems();
          for (const it of sel){ const t = it.getBindingContext().getObject(); await deleteTask(t.id); }
          list.removeSelections(true); updateBulkButtons();
          sap.m.MessageToast.show('Ausgewählte Aufgaben gelöscht');
        }
        function onExport(){
          const data = model.getProperty('/tasks')||[];
          const blob = new Blob([JSON.stringify(data, null, 2)], { type:'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a'); a.href = url; a.download = 'tasks-export.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 1000);
        }
        async function onImportChange(ev){
          const file = ev.getParameter('files') && ev.getParameter('files')[0]; if (!file) return;
          const text = await file.text();
          try {
            const arr = JSON.parse(text);
            if (Array.isArray(arr)){
              for (const t of arr){
                const payload = { title: t.title||'Ohne Titel', description: t.description||'', priority: t.priority||'mittel', status: t.status||'offen', dueAt: t.dueAt||'' };
                await createTask(payload);
              }
              sap.m.MessageToast.show('Import erfolgreich');
            }
          } catch(err){ sap.m.MessageToast.show('Import fehlgeschlagen'); }
          ev.getSource().clear();
        }

        // Dialogs
        let dlg;
        function buildTaskForm(data){
          const title = new sap.m.Input({ value: data.title || '', placeholder:'Titel eingeben', liveChange:(e)=>{ const v=e.getSource().getValue(); e.getSource().setValueState(v? 'None':'Error'); } });
          title.setValueState(title.getValue()? 'None':'Error');
          const desc = new sap.m.TextArea({ value: data.description || '', rows:4, placeholder:'Beschreibung' });
          const prio = new sap.m.Select({ selectedKey: data.priority || 'mittel', items:[
            new sap.ui.core.Item({ key:'hoch', text:'Hoch' }),
            new sap.ui.core.Item({ key:'mittel', text:'Mittel' }),
            new sap.ui.core.Item({ key:'niedrig', text:'Niedrig' })
          ]});
          const status = new sap.m.Select({ selectedKey: data.status || 'offen', items:[
            new sap.ui.core.Item({ key:'offen', text:'Offen' }),
            new sap.ui.core.Item({ key:'in_arbeit', text:'In Arbeit' }),
            new sap.ui.core.Item({ key:'abgeschlossen', text:'Abgeschlossen' })
          ]});
          const due = new sap.m.DateTimePicker({ value: data.dueAt || '', displayFormat:'dd.MM.yyyy, HH:mm', valueFormat:'yyyy-MM-ddTHH:mm' });
          const tagsInput = new sap.m.Input({ value: (Array.isArray(data.tags)? data.tags.join(', '): (data.tags||'')), placeholder:'Tags (kommagetrennt)' });
          return { title, desc, prio, status, due, tagsInput };
        }
        const TEMPLATES = [
          { key:'', text:'Vorlage wählen' },
          { key:'hygiene', text:'Hygiene-Check', data:{ title:'Hygiene-Check durchführen', description:'Tägliche Reinigung und Checkliste abarbeiten', priority:'hoch', status:'offen', tags:'Hygiene,Frische', dueAt:'' } },
          { key:'inventur', text:'Inventur Spotcheck', data:{ title:'Inventur-Spotcheck Lagergang C', description:'Stichprobe Zählung durchführen und Abweichungen protokollieren', priority:'mittel', status:'offen', tags:'Inventur,Lager', dueAt:'' } },
          { key:'mhd', text:'MHD-Kontrolle', data:{ title:'MHD-Kontrolle Kühlregal', description:'Ablaufende Ware aussortieren und reduzieren', priority:'hoch', status:'in_arbeit', tags:'Hygiene,Frische', dueAt:'' } }
        ];
        function applyTemplateToForm(tplKey, formRefs){
          const tpl = TEMPLATES.find(t=>t.key===tplKey);
          if (!tpl || !tpl.data) return;
          const d = tpl.data;
          formRefs.title.setValue(d.title||'');
          formRefs.desc.setValue(d.description||'');
          formRefs.prio.setSelectedKey(d.priority||'mittel');
          formRefs.status.setSelectedKey(d.status||'offen');
          formRefs.due.setValue(d.dueAt||'');
          formRefs.tagsInput.setValue(d.tags||'');
        }
        function openCreateDialog(){
          if (!model.getProperty('/canPlanTasks')){
            sap.m.MessageToast.show('Nur Filialleiter können neue Aufgaben planen.');
            return;
          }
          const f = buildTaskForm({});
          let heroImg = new sap.m.Image({ src:'', decorative:true, width:'100%', height:'160px', visible:false }).addStyleClass('detail-hero sapUiSmallMarginBottom');
          const imgInput = new sap.m.Input({ value:'', placeholder:'Bild-URL (optional)', liveChange:(e)=>{ const v = e.getParameter('value'); if (v){ heroImg.setSrc(v); heroImg.setVisible(true); } else { heroImg.setVisible(false); } } });
          const procSel = new sap.m.Select({ width:'100%', items:[
            new sap.ui.core.Item({ key:'', text:'Prozess wählen' }),
            new sap.ui.core.Item({ key:'we', text:'Wareneingang' }),
            new sap.ui.core.Item({ key:'aktion', text:'Aktion' }),
            new sap.ui.core.Item({ key:'frische', text:'Frische' }),
            new sap.ui.core.Item({ key:'qm', text:'Qualitätsmeldung' }),
            new sap.ui.core.Item({ key:'inventur', text:'Inventur' })
          ]});
          const srcTypeSel = new sap.m.Select({ width:'100%', items:[
            new sap.ui.core.Item({ key:'', text:'Belegart wählen' }),
            new sap.ui.core.Item({ key:'DELIVERY', text:'Lieferschein' }),
            new sap.ui.core.Item({ key:'PO', text:'Bestellung' }),
            new sap.ui.core.Item({ key:'STO', text:'Umlagerung' }),
            new sap.ui.core.Item({ key:'PROMO', text:'Aktion' }),
            new sap.ui.core.Item({ key:'QMNOTIF', text:'QM-Meldung' })
          ]});
          const srcIdInput = new sap.m.Input({ value:'', placeholder:'Belegnummer / Referenz' });
          const compPreview = new sap.m.ObjectStatus({ text:'{= "Buchung: " + ${/tmpCompLabel} }', state:'None' });
          const tmpModel = new sap.ui.model.json.JSONModel({ comp: 'NONE', compLabel: fmt.completionLabel('NONE') });
          compPreview.bindText('/tmpCompLabel');
          function syncComp(){ const a=processToAction(procSel.getSelectedKey()); tmpModel.setProperty('/tmpComp', a); tmpModel.setProperty('/tmpCompLabel', fmt.completionLabel(a)); }
          procSel.attachChange(syncComp);
          syncComp();
          const templateSel = new sap.m.Select({ width:'100%', items: TEMPLATES.map(t=> new sap.ui.core.Item({ key:t.key, text:t.text })), change:(e)=>{ applyTemplateToForm(e.getSource().getSelectedKey(), f); } });
          const form = new sap.ui.layout.form.SimpleForm({ editable:true, layout:'ResponsiveGridLayout', labelSpanXL:3, labelSpanL:3, labelSpanM:4, adjustLabelSpan:false, content:[
            new sap.m.Label({text:'Vorlage'}), templateSel,
            new sap.m.Label({text:'Titel'}), f.title,
            new sap.m.Label({text:'Beschreibung'}), f.desc,
            new sap.m.Label({text:'Priorität'}), f.prio,
            new sap.m.Label({text:'Status'}), f.status,
            new sap.m.Label({text:'Fällig bis'}), f.due,
            new sap.m.Label({text:'Tags'}), f.tagsInput,
            new sap.m.Label({text:'Prozess'}), procSel,
            new sap.m.Label({text:'Belegart'}), srcTypeSel,
            new sap.m.Label({text:'Belegnummer'}), srcIdInput,
            new sap.m.Label({text:'Buchung'}), compPreview,
            new sap.m.Label({text:'Bild URL'}), imgInput
          ]});
          dlg = new sap.m.Dialog({ contentWidth:'640px', contentHeight:'auto', stretchOnPhone:true, content:[ heroImg, form ],
            customHeader: new sap.m.Bar({ contentLeft:[ new sap.ui.core.Icon({ src:'sap-icon://add', color:'AccentColor1' }), new sap.m.Title({ text:'Neue Aufgabe' }) ], contentRight:[ new sap.m.Button({ icon:'sap-icon://decline', tooltip:'Schließen', press: ()=>dlg.close() }) ] }),
            beginButton: new sap.m.Button({ text:'Speichern', type:'Emphasized', press: async ()=>{
            if (!f.title.getValue()){ f.title.setValueState('Error'); return; }
            await createTask({ title:f.title.getValue(), description:f.desc.getValue(), priority:f.prio.getSelectedKey(), status:f.status.getSelectedKey(), dueAt:f.due.getValue(), tags: f.tagsInput.getValue(), image: imgInput.getValue(), processType: procSel.getSelectedKey(), sourceDoc:{ type: srcTypeSel.getSelectedKey(), id: srcIdInput.getValue() }, completionAction: processToAction(procSel.getSelectedKey()) });
            dlg.close(); dlg.destroy();
          }}), endButton: new sap.m.Button({ text:'Abbrechen', press: ()=>{ dlg.close(); dlg.destroy(); } }) });
          dlg.open();
        }
        async function openEditDialog(task){
          const f = buildTaskForm(task);
          const canDelete = model.getProperty('/canPlanTasks');
          const cModel = new sap.ui.model.json.JSONModel({ items: await fetchComments(task.id), text:'' });
          const commentList = new sap.m.List({ headerText:'Kommentare' });
          commentList.bindItems({ path:'c>/items', template: new sap.m.FeedListItem({ text:'{c>text}', sender:'{c>author}', icon:{ path:'c>author', formatter:function(a){ return a&&a.toLowerCase().includes('leitung')? 'sap-icon://manager' : 'sap-icon://employee'; } }, info:{ path:'c>createdAt', formatter: fmt.relative } }) });
          const feed = new sap.m.FeedInput({ placeholder:'Kommentar hinzufügen...', post: async (e)=>{ const text = e.getParameter('text'); if(!text) return; const c = await postComment(task.id, text); const arr=cModel.getProperty('/items'); arr.push(c); cModel.setProperty('/items', arr); } });

          const heroUrl = (task && (task.image || task.banner)) || fmt.imageByMeta(task && task.priority, task && task.status, task && task.tags);
          const heroImg = new sap.m.Image({ src: heroUrl, decorative:true, width:'100%', height:'160px' }).addStyleClass('detail-hero sapUiSmallMarginBottom');
          const imgInputEdit = new sap.m.Input({ value: task && task.image || '', placeholder:'Bild-URL (optional)', liveChange:(e)=>{ const v = e.getParameter('value'); heroImg.setSrc(v||heroUrl); heroImg.setVisible(!!(v||heroUrl)); } });
          const procKey = (task && task.processType) || '';
          const docTypeKey = (task && task.sourceDoc && task.sourceDoc.type) || '';
          const isWE = procKey === 'we';
          const isExternalWE = isWE && (docTypeKey==='PO' || docTypeKey==='DELIVERY' || docTypeKey==='');
          const isTransferWE = isWE && (docTypeKey==='STO');
          const f1248Hint = new sap.m.MessageStrip({
            text:'Externer Wareneingang: Bitte über die Fiori-App F1248 „Produkte empfangen“ verbuchen.',
            type:'Information', showIcon:true, visible: isExternalWE
          }).addStyleClass('sapUiSmallMarginBottom');

          const footer = new sap.m.HBox({ justifyContent:'SpaceBetween', width:'100%', items:[
            new sap.m.Button({ text:'Löschen', type:'Reject', visible: canDelete, press: async ()=>{ await deleteTask(task.id); dlg.close(); dlg.destroy(); } }),
            new sap.m.Button({ text:'Vorgang abschließen (Mock)', type:'Emphasized', visible: (isTransferWE && (model.getProperty('/canPlanTasks') || model.getProperty('/canAccessAdmin'))), press: async ()=>{ await mockCompleteTask(task); dlg.close(); dlg.destroy(); } }),
            new sap.m.Button({ text:'Speichern', type:'Default', press: async ()=>{ if (!f.title.getValue()){ f.title.setValueState('Error'); return; } await updateTask(task.id, { title:f.title.getValue(), description:f.desc.getValue(), priority:f.prio.getSelectedKey(), status:f.status.getSelectedKey(), dueAt:f.due.getValue(), tags: f.tagsInput.getValue(), image: imgInputEdit.getValue() }); dlg.close(); dlg.destroy(); } })
          ]});

          const form = new sap.ui.layout.form.SimpleForm({ editable:true, layout:'ResponsiveGridLayout', labelSpanXL:3, labelSpanL:3, labelSpanM:4, adjustLabelSpan:false, content:[
            new sap.m.Label({text:'Titel'}), f.title,
            new sap.m.Label({text:'Beschreibung'}), f.desc,
            new sap.m.Label({text:'Priorität'}), f.prio,
            new sap.m.Label({text:'Status'}), f.status,
            new sap.m.Label({text:'Fällig bis'}), f.due,
            new sap.m.Label({text:'Tags'}), f.tagsInput,
            new sap.m.Label({text:'Prozess'}), new sap.m.Select({ selectedKey: (task && task.processType)||'', items:[ new sap.ui.core.Item({ key:'', text:'Prozess wählen' }), new sap.ui.core.Item({ key:'we', text:'Wareneingang' }), new sap.ui.core.Item({ key:'aktion', text:'Aktion' }), new sap.ui.core.Item({ key:'frische', text:'Frische' }), new sap.ui.core.Item({ key:'qm', text:'Qualitätsmeldung' }), new sap.ui.core.Item({ key:'inventur', text:'Inventur' }) ] }),
            new sap.m.Label({text:'Belegart'}), new sap.m.Input({ value: (task && task.sourceDoc && task.sourceDoc.type) || '', placeholder:'z. B. DELIVERY, PO, STO, PROMO' }),
            new sap.m.Label({text:'Belegnummer'}), new sap.m.Input({ value: (task && task.sourceDoc && task.sourceDoc.id) || '', placeholder:'z. B. 8000..., 45...' }),
            new sap.m.Label({text:'Buchung'}), new sap.m.ObjectStatus({ text: (task && task.completionAction) ? ('Buchung: ' + fmt.completionLabel(task.completionAction)) : 'Buchung: Keine', state:'None' }),
            new sap.m.Label({text:'Bild URL'}), imgInputEdit
          ]});

          dlg = new sap.m.Dialog({ contentWidth:'720px', contentHeight:'auto', stretchOnPhone:true, content:[
            heroImg,
            f1248Hint,
            form,
            new sap.m.Toolbar({ content:[ new sap.m.Title({ text:'Kommentare' }) ] }),
            commentList,
            feed,
          ], buttons: [], endButton: new sap.m.Button({ text:'Schließen', press: ()=>{ dlg.close(); dlg.destroy(); } }), customHeader: new sap.m.Bar({ contentLeft:[ new sap.ui.core.Icon({ src:'sap-icon://edit', color:'AccentColor1' }), new sap.m.Title({ text:'Aufgabe bearbeiten' }) ], contentRight:[ new sap.m.Button({ icon:'sap-icon://decline', tooltip:'Schließen', press: ()=>dlg.close() }) ] }) });
          dlg.setModel(cModel,'c');
          dlg.addContent(new sap.m.Toolbar({ content:[ new sap.m.ToolbarSpacer(), footer ] }));
          dlg.open();
        }

        // ----- Updates/Guides/Events Tabs -----
        function escapeHtml(str){
          return String(str == null ? '' : str)
            .replace(/&/g,'&amp;')
            .replace(/</g,'&lt;')
            .replace(/>/g,'&gt;')
            .replace(/"/g,'&quot;')
            .replace(/'/g,'&#39;');
        }

        function detailPanel(title, icon, controls){
          if (!controls || !Array.isArray(controls) || !controls.length) { return null; }
          const iconControl = new sap.ui.core.Icon({ src: icon, size: '1.2rem', decorative: false });
          iconControl.addStyleClass('detail-panel__icon');
          const toolbar = new sap.m.Toolbar({ content:[ iconControl, new sap.m.Title({ text: title }), new sap.m.ToolbarSpacer() ] });
          toolbar.addStyleClass('detail-panel__toolbar');
          const panel = new sap.m.Panel({ expandable:false, expanded:true, headerToolbar: toolbar }).addStyleClass('detail-panel');
          panel.addContent(new sap.m.VBox({ width:'100%', items: controls }));
          return panel;
        }

        function buildGuideDetailContent(guide){
          if (!guide || typeof guide !== 'object') { return []; }
          const toArray = (val)=>{
            if (!val) return [];
            if (Array.isArray(val)) return val.filter(Boolean);
            return String(val).split(',').map(s=>s.trim()).filter(Boolean);
          };
          const tags = toArray(guide.tags);
          const prerequisites = toArray(guide.prerequisites);
          const steps = Array.isArray(guide.steps) ? guide.steps.filter(Boolean) : [];
          const resources = Array.isArray(guide.resources) ? guide.resources.filter(Boolean) : [];

          const sections = [];
          const description = String(guide.description || guide.summary || '').trim();

          const overviewControls = [];
          if (description){
            overviewControls.push(new sap.m.FormattedText({
              htmlText: '<div class="detail-section">'+escapeHtml(description).replace(/\n/g,'<br>')+'</div>',
              sanitizeContent: true
            }).addStyleClass('sapUiSmallMarginBottom detail-description'));
          }

          const metaChips = [];
          if (guide.duration){
            metaChips.push(new sap.m.ObjectStatus({
              text: 'Dauer: ' + guide.duration,
              icon: 'sap-icon://time-entry-request',
              state: 'Information'
            }).addStyleClass('sapUiTinyMarginEnd'));
          }
          if (guide.difficulty){
            const diffState = guide.difficulty === 'Einsteiger' ? 'Success' : (guide.difficulty === 'Fortgeschritten' ? 'Warning' : 'None');
            metaChips.push(new sap.m.ObjectStatus({
              text: 'Level: ' + guide.difficulty,
              icon: 'sap-icon://initiative',
              state: diffState
            }).addStyleClass('sapUiTinyMarginEnd'));
          }
          if (guide.owner){
            metaChips.push(new sap.m.ObjectStatus({
              text: 'Verantwortlich: ' + guide.owner,
              icon: 'sap-icon://person-placeholder',
              state: 'None'
            }).addStyleClass('sapUiTinyMarginEnd'));
          }
          if (metaChips.length){
            overviewControls.push(new sap.m.FlexBox({ wrap: 'Wrap', alignItems:'Center', items: metaChips }).addStyleClass('detail-meta sapUiSmallMarginBottom'));
          }

          const summaryBadges = [];
          if (steps.length){
            summaryBadges.push(new sap.m.ObjectStatus({ text: steps.length + ' Schritte', icon:'sap-icon://process', state:'Success' }));
          }
          if (prerequisites.length){
            summaryBadges.push(new sap.m.ObjectStatus({ text: prerequisites.length + ' Voraussetzungen', icon:'sap-icon://checklist', state:'None' }));
          }
          if (resources.length){
            summaryBadges.push(new sap.m.ObjectStatus({ text: resources.length + ' Ressourcen', icon:'sap-icon://attachment', state:'None' }));
          }
          if (summaryBadges.length){
            overviewControls.push(new sap.m.Toolbar({ content: summaryBadges }).addStyleClass('sapUiSmallMarginBottom detail-meta'));
          }

          const overviewPanel = detailPanel('Überblick', 'sap-icon://overview-chart', overviewControls);
          if (overviewPanel) { sections.push(overviewPanel); }

          if (tags.length){
            const tokenizer = new sap.m.Tokenizer({ editable:false, width:'100%' });
            tags.forEach(tag=> tokenizer.addToken(new sap.m.Token({ key: tag, text: tag })));
            tokenizer.addStyleClass('detail-tokenizer');
            const tagPanel = detailPanel('Tags', 'sap-icon://tags', [ tokenizer ]);
            if (tagPanel) { sections.push(tagPanel); }
          }

          if (prerequisites.length){
            const prereqList = new sap.m.List({ inset:false, showSeparators:'Inner' });
            prereqList.bindItems({
              path:'/',
              template: new sap.m.StandardListItem({ title:'{text}' })
            });
            prereqList.setModel(new sap.ui.model.json.JSONModel(prerequisites.map(text=>({ text }))));
            const prereqPanel = detailPanel('Voraussetzungen', 'sap-icon://clipboard', [ prereqList ]);
            if (prereqPanel) { sections.push(prereqPanel); }
          }

          if (steps.length){
            const stepList = new sap.m.List({ inset:false, showSeparators:'Inner' });
            stepList.bindItems({
              path:'/',
              template: new sap.m.ObjectListItem({
                title:'{title}',
                number:'{index}',
                numberState:'Information',
                type:'Inactive',
                attributes:[ new sap.m.ObjectAttribute({ text:'{detail}' }) ]
              })
            });
            const stepData = steps.map((step, idx)=>({ index: (idx+1)+'.', title: step.title || ('Schritt '+(idx+1)), detail: step.detail || '' }));
            stepList.setModel(new sap.ui.model.json.JSONModel(stepData));
            const stepsPanel = detailPanel('Schritte', 'sap-icon://process', [ stepList ]);
            if (stepsPanel) { sections.push(stepsPanel); }
          }

          if (resources.length){
            const resourceList = new sap.m.List({ inset:false, showSeparators:'Inner', mode:'None' });
            resourceList.bindItems({
              path:'/',
              template: new sap.m.CustomListItem({
                content:[ new sap.m.HBox({
                  justifyContent:'SpaceBetween',
                  alignItems:'Center',
                  items:[
                    new sap.m.VBox({ items:[ new sap.m.Title({ text:'{label}' }), new sap.m.Text({ text:'{type}' }) ] }),
                    new sap.m.Button({ text:'Öffnen', type:'Transparent', icon:'sap-icon://open-command-field', press:(oEvent)=>{
                      try{
                        const data = oEvent.getSource().getBindingContext().getObject();
                        sap.m.MessageToast.show('Ressource "'+ (data && (data.label || data.name || data.type || 'Ressource')) +'" öffnen (Demo)');
                      }catch(_){ sap.m.MessageToast.show('Ressource öffnen (Demo)'); }
                    } })
                  ]
                }) ]
              })
            });
            resourceList.setModel(new sap.ui.model.json.JSONModel(resources.map(res=>({ label: res.label || res.name || 'Ressource', type: res.type || '', url: res.url || '' }))));
            const resourcePanel = detailPanel('Ressourcen & Anhänge', 'sap-icon://attachment', [ resourceList ]);
            if (resourcePanel) { sections.push(resourcePanel); }
          }

          return sections;
        }

        function buildUpdateDetailContent(update){
          if (!update || typeof update !== 'object') { return []; }
          const toArray = (val)=>{
            if (!val) return [];
            if (Array.isArray(val)) return val.filter(Boolean);
            return String(val).split(',').map(s=>s.trim()).filter(Boolean);
          };
          const actionItems = Array.isArray(update.actionItems) ? update.actionItems.filter(Boolean) : [];
          const attachments = Array.isArray(update.attachments) ? update.attachments.filter(Boolean) : [];
          const tags = toArray(update.tags);

          const sections = [];
          const summary = String(update.summary || '').trim();
          const overviewControls = [];
          if (summary){
            overviewControls.push(new sap.m.MessageStrip({
              text: summary,
              type: 'Information',
              showCloseButton:false,
              showIcon:true
            }).addStyleClass('sapUiSmallMarginBottom detail-summary'));
          }

          const metaContent = [];
          if (update.category){ metaContent.push(new sap.m.ObjectStatus({ text:'Kategorie: ' + update.category, icon:'sap-icon://tags', state:'Information' })); }
          if (update.priority){
            const prioLower = String(update.priority).toLowerCase();
            const prioState = prioLower==='hoch' ? 'Error' : (prioLower==='mittel' ? 'Warning' : 'Success');
            metaContent.push(new sap.m.ObjectStatus({ text:'Priorität: ' + update.priority, icon:'sap-icon://favorite', state: prioState }));
          }
          if (update.owner){ metaContent.push(new sap.m.ObjectStatus({ text:'Verantwortlich: ' + update.owner, icon:'sap-icon://account', state:'None' })); }
          if (update.impact){ metaContent.push(new sap.m.ObjectStatus({ text:'Betroffene: ' + update.impact, icon:'sap-icon://group', state:'None' })); }
          if (update.date){ metaContent.push(new sap.m.ObjectStatus({ text:'Datum: ' + update.date, icon:'sap-icon://history', state:'None' })); }
          if (metaContent.length){ overviewControls.push(new sap.m.Toolbar({ content: metaContent }).addStyleClass('detail-meta sapUiSmallMarginBottom')); }

          const narrative = String(update.content || '').trim();
          if (narrative){
            overviewControls.push(new sap.m.FormattedText({
              htmlText: '<div class="detail-section">'+escapeHtml(narrative).replace(/\n/g,'<br>')+'</div>',
              sanitizeContent:true
            }).addStyleClass('sapUiSmallMarginBottom detail-description'));
          }

          const overviewPanel = detailPanel('Überblick', 'sap-icon://notification', overviewControls);
          if (overviewPanel) { sections.push(overviewPanel); }

          if (tags.length){
            const tokenizer = new sap.m.Tokenizer({ editable:false, width:'100%' });
            tags.forEach(tag=> tokenizer.addToken(new sap.m.Token({ key: tag, text: tag })));
            tokenizer.addStyleClass('detail-tokenizer');
            const tagPanel = detailPanel('Tags', 'sap-icon://tag', [ tokenizer ]);
            if (tagPanel) { sections.push(tagPanel); }
          }

          if (actionItems.length){
            const actionList = new sap.m.List({ inset:false, showSeparators:'Inner', mode:'None' });
            actionList.bindItems({
              path:'/',
              template: new sap.m.CustomListItem({
                content:[ new sap.m.HBox({
                  justifyContent:'SpaceBetween',
                  alignItems:'Start',
                  items:[
                    new sap.m.VBox({
                      items:[ new sap.m.Title({ text:'{title}' }), new sap.m.Text({ text:{ path:'detail', formatter:function(v){ return v ? v : ''; } }, wrapping:true }) ]
                    }),
                    new sap.m.ObjectStatus({
                      text:{ path:'dueAt', formatter:function(val){ return val ? ('Fällig: ' + fmt.dueText(val)) : 'Termin offen'; } },
                      state:{ path:'dueAt', formatter:function(val){ return val && fmt.overdue(val) ? 'Error' : 'None'; } }
                    })
                  ]
                }) ]
              })
            });
            const actionData = actionItems.map(item=>({
              title: item.title || 'Aufgabe',
              detail: item.detail || '',
              dueAt: item.dueAt || ''
            }));
            actionList.setModel(new sap.ui.model.json.JSONModel(actionData));
            const actionPanel = detailPanel('Maßnahmen & Aufgaben', 'sap-icon://task', [ actionList ]);
            if (actionPanel) { sections.push(actionPanel); }
          }

          if (attachments.length){
            const attachmentList = new sap.m.List({ inset:false, showSeparators:'Inner', mode:'None' });
            attachmentList.bindItems({
              path:'/',
              template: new sap.m.CustomListItem({
                content:[ new sap.m.HBox({
                  justifyContent:'SpaceBetween',
                  alignItems:'Center',
                  items:[
                    new sap.m.VBox({ items:[ new sap.m.Title({ text:'{label}' }), new sap.m.Text({ text:'{type}' }) ] }),
                    new sap.m.Button({ text:'Öffnen', type:'Transparent', icon:'sap-icon://attachment', press:(oEvent)=>{
                      try{
                        const data = oEvent.getSource().getBindingContext().getObject();
                        sap.m.MessageToast.show('Anhang "'+ (data && (data.label || data.type || 'Dokument')) +'" öffnen (Demo)');
                      }catch(_){ sap.m.MessageToast.show('Anhang öffnen (Demo)'); }
                    } })
                  ]
                }) ]
              })
            });
            attachmentList.setModel(new sap.ui.model.json.JSONModel(attachments.map(att=>({ label: att.name || att.label || 'Anhang', type: att.type || '', url: att.url || '' }))));
            const attachmentPanel = detailPanel('Anhänge', 'sap-icon://paperclip', [ attachmentList ]);
            if (attachmentPanel) { sections.push(attachmentPanel); }
          }

          return sections;
        }

        function buildEventDetailContent(event){
          if (!event || typeof event !== 'object') { return []; }
          const sections = [];
          const description = String(event.description || event.detail || '').trim();

          const overviewControls = [];
          if (description){
            overviewControls.push(new sap.m.FormattedText({
              htmlText: '<div class="detail-section">'+escapeHtml(description).replace(/\n/g,'<br>')+'</div>',
              sanitizeContent:true
            }).addStyleClass('sapUiSmallMarginBottom detail-description'));
          }
          const meta = [];
          const dateVal = event.date || event.when || event.time || '';
          if (dateVal){ meta.push(new sap.m.ObjectStatus({ text:'Termin: ' + String(dateVal), icon:'sap-icon://calendar', state:'Information' })); }
          const location = event.location || event.place || '';
          if (location){ meta.push(new sap.m.ObjectStatus({ text:'Ort: ' + location, icon:'sap-icon://map-2', state:'None' })); }
          const responsible = event.responsible || event.owner || '';
          if (responsible){ meta.push(new sap.m.ObjectStatus({ text:'Verantwortlich: ' + responsible, icon:'sap-icon://badge', state:'None' })); }
          if (meta.length){ overviewControls.push(new sap.m.Toolbar({ content: meta }).addStyleClass('detail-meta sapUiSmallMarginBottom')); }
          if (!description && !meta.length){
            overviewControls.push(new sap.m.IllustratedMessage({ illustrationType:'sapIllus-SceneNoData', title:'Überblick', description:'Für diesen Aktionstag liegen noch keine Detailinformationen vor.' }));
          }
          const overviewPanel = detailPanel('Überblick', 'sap-icon://event', overviewControls);
          if (overviewPanel) { sections.push(overviewPanel); }

          if (Array.isArray(event.checklist) && event.checklist.length){
            const checklist = new sap.m.List({ inset:false, showSeparators:'Inner' });
            checklist.bindItems({
              path:'/',
              template: new sap.m.CustomListItem({
                content:[ new sap.m.HBox({
                  alignItems:'Start',
                  justifyContent:'SpaceBetween',
                  items:[
                    new sap.m.VBox({ items:[ new sap.m.Title({ text:'{title}' }), new sap.m.Text({ text:'{detail}', wrapping:true }) ] }),
                    new sap.ui.core.Icon({ src:'sap-icon://accept', decorative:false, color:'Positive' })
                  ]
                }) ]
              })
            });
            const checklistData = event.checklist.map(item=>({ title: item.title || item, detail: item.detail || '' }));
            checklist.setModel(new sap.ui.model.json.JSONModel(checklistData));
            const checklistPanel = detailPanel('Checkliste', 'sap-icon://list', [ checklist ]);
            if (checklistPanel) { sections.push(checklistPanel); }
          }

          if (Array.isArray(event.participants) && event.participants.length){
            const participants = new sap.m.List({ inset:false, showSeparators:'Inner' });
            participants.bindItems({
              path:'/',
              template: new sap.m.StandardListItem({ title:'{name}', info:'{role}' })
            });
            participants.setModel(new sap.ui.model.json.JSONModel(event.participants.map(p=>({ name: p.name || p, role: p.role || '' }))));
            const participantPanel = detailPanel('Teilnehmende', 'sap-icon://group', [ participants ]);
            if (participantPanel) { sections.push(participantPanel); }
          }

          return sections.length ? sections : [ new sap.m.Text({ text:'Keine Detailinformationen verfügbar.' }) ];
        }

        function makeSimpleTab(cfg){
          const sModelPath = cfg.path;
          const descProp = cfg.desc || 'description';
          const infoProp = cfg.info || '';
          const detailBuilder = typeof cfg.detailBuilder === 'function' ? cfg.detailBuilder : null;
          const titleProp = cfg.titleProp || 'title';
          const state = new sap.ui.model.json.JSONModel({ q:'', sort:'title_asc', page:1, pageSize:10, total:0, itemsCount:0, pageLabel:'', infoLabel:'', canPrev:false, canNext:false });
          const dataModel = new sap.ui.model.json.JSONModel({ items:[] });
          let list;
          async function loadPage(){
            const page = state.getProperty('/page');
            const pageSize = state.getProperty('/pageSize');
            const q = encodeURIComponent(state.getProperty('/q')||'');
            const sort = encodeURIComponent(state.getProperty('/sort')||'');
            const url = api + sModelPath + `?page=${page}&pageSize=${pageSize}` + (q?`&q=${q}`:'') + (sort?`&sort=${sort}`:'');
            try{
              if (list) list.setBusy(true);
              const resp = await fetch(url);
              const json = await resp.json();
              if (json && json.items){ dataModel.setProperty('/items', json.items); state.setProperty('/total', json.total||json.items.length); state.setProperty('/itemsCount', (json.items||[]).length); }
              else { const arr = Array.isArray(json)? json : []; dataModel.setProperty('/items', arr); state.setProperty('/total', arr.length); state.setProperty('/itemsCount', arr.length); }
            }catch(_){ /* ignore */ } finally { if (list) list.setBusy(false); }
            const p = state.getProperty('/page');
            const tot = state.getProperty('/total');
            const ps = state.getProperty('/pageSize');
            const pages = Math.max(1, Math.ceil((tot||0)/(ps||1)));
            state.setProperty('/pageLabel', 'Seite ' + p + ' von ' + pages);
            state.setProperty('/infoLabel', 'Einträge: ' + state.getProperty('/itemsCount') + (tot? (' / ' + tot):''));
            state.setProperty('/canPrev', p > 1);
            state.setProperty('/canNext', p < pages);
          }
          const search = new sap.m.SearchField({ liveChange: async e=>{ state.setProperty('/q', e.getSource().getValue()); state.setProperty('/page', 1); await loadPage(); } });
          const sortSel = new sap.m.Select({ selectedKey:'title_asc', change: async e=>{ state.setProperty('/sort', e.getSource().getSelectedKey()); state.setProperty('/page', 1); await loadPage(); }, items:[
            new sap.ui.core.Item({ key:'title_asc', text:'Titel A→Z' }),
            new sap.ui.core.Item({ key:'title_desc', text:'Titel Z→A' })
          ]});
          list = new sap.m.List({ growing:true, growingScrollToLoad:true });
          list.setNoDataText('Keine Einträge');
          const tpl = new sap.m.ObjectListItem({
            title: `{${titleProp}}`,
            intro: infoProp ? `{${infoProp}}` : '',
            introActive: false,
            number: '',
            icon: '{image}',
            iconDensityAware: false,
            attributes:[ new sap.m.ObjectAttribute({ text: `{${descProp}}`, active:false }) ],
            firstStatus: new sap.m.ObjectStatus({ text: infoProp?`{${infoProp}}`:'' , state:'Information' }),
            markers:[ new sap.m.ObjectMarker({ type:'Favorite', visible:{ path:'priority', formatter:(p)=> !!p && p.toLowerCase()==='hoch' } }) ],
            type: 'Active'
          });
          list.bindItems({ path: '/items', template: tpl });
          list.setModel(dataModel);
          list.attachItemPress((ev)=>{
            const obj = ev.getParameter('listItem').getBindingContext().getObject();
            let d;
            const titleText = obj && obj[titleProp] ? String(obj[titleProp]) : 'Detail';
            const bannerUrl = (obj && (obj.image || obj.banner)) || (obj && obj.category && obj.category.toLowerCase()==='promo' ? 'https://images.unsplash.com/photo-1512295767273-ac109ac3acfa?w=1200&q=60' : (obj && obj.type==='event' ? 'https://images.unsplash.com/photo-1511578314322-379afb476865?w=1200&q=60' : ''));
            const banner = bannerUrl ? new sap.m.Image({ src: bannerUrl, width:'100%', height:'160px', decorative:true }).addStyleClass('sapUiSmallMarginBottom') : new sap.m.Toolbar({ content:[ new sap.m.Title({ text:titleText }) ] });
            const header = new sap.m.Bar({
              contentLeft:[ new sap.m.Title({ text: titleText }) ],
              contentMiddle:[ infoProp && obj && obj[infoProp] ? new sap.m.ObjectStatus({ text: String(obj[infoProp]), state:'Information' }) : new sap.m.Text({ visible:false }) ],
              contentRight:[ new sap.m.Button({ icon:'sap-icon://decline', press: ()=> d && d.close() }) ]
            });
            const defaultDescription = descProp ? String(obj && obj[descProp] || '') : '';
            const defaultControls = [];
            if (defaultDescription){
              defaultControls.push(new sap.m.FormattedText({ htmlText: '<div class="detail-section">'+escapeHtml(defaultDescription).replace(/\n/g,'<br>')+'</div>', sanitizeContent:true }).addStyleClass('sapUiSmallMarginBottom detail-description'));
            }
            if (infoProp && obj && obj[infoProp] != null){
              defaultControls.push(new sap.m.ObjectStatus({ text: String(obj[infoProp]), state:'Information' }));
            }
            const builtControls = detailBuilder ? detailBuilder(obj) : null;
            let contentItems = Array.isArray(builtControls) && builtControls.length ? builtControls : defaultControls;
            if (!contentItems.length){
              const illu = new sap.m.IllustratedMessage({ illustrationType:'sapIllus-SceneNoData', title:'Keine Details vorhanden', description:'Für diesen Eintrag liegen derzeit keine weiteren Informationen vor.' });
              contentItems = [ illu ];
            }
            const body = new sap.m.ScrollContainer({
              vertical:true,
              focusable:false,
              width:'100%',
              content: [ new sap.m.VBox({ width:'100%', renderType:'Bare', items: (bannerUrl? [ banner ]: []).concat(contentItems.length ? contentItems : [ new sap.m.Text({ text:'Keine Details vorhanden.' }) ]) }) ]
            });
            d = new sap.m.Dialog({ contentWidth:'880px', contentHeight:'560px', stretchOnPhone:true, draggable:true, resizable:true, customHeader: header, content: [ body ], buttons:[
              new sap.m.Button({ text:'Als erledigt markieren', type:'Emphasized', visible: cfg && cfg.action === 'update', press: ()=>{ sap.m.MessageToast.show('Demo-Aktion ausgeführt'); } }),
              new sap.m.Button({ text:'Schließen', press: ()=> d.close() })
            ] });
            d.open();
          });
          const pageSizeSel = new sap.m.Select({ width:'8rem', selectedKey:'{state>/pageSize}', change: async (e)=>{ state.setProperty('/pageSize', Number(e.getSource().getSelectedKey())); state.setProperty('/page', 1); await loadPage(); }, items:[
          new sap.ui.core.Item({ key:'5', text:'5 / Seite' }),
          new sap.ui.core.Item({ key:'10', text:'10 / Seite' }),
          new sap.ui.core.Item({ key:'20', text:'20 / Seite' })
        ]});
          const infoBar = new sap.m.Toolbar({ content:[ new sap.m.ObjectStatus({ text:'{state>/infoLabel}', state:'None' }) ]});
          const pager = new sap.m.Toolbar({ content:[
            new sap.m.Button({ text:'Zurück', enabled: '{state>/canPrev}', press: async ()=>{ const p = state.getProperty('/page')-1; state.setProperty('/page', p); await loadPage(); } }),
            new sap.m.Text({ text: '{state>/pageLabel}' }),
            new sap.m.Button({ text:'Weiter', enabled:'{state>/canNext}', press: async ()=>{ const p = state.getProperty('/page')+1; state.setProperty('/page', p); await loadPage(); } }),
            new sap.m.Button({ text:'Reset', press: async ()=>{ state.setProperty('/q', ''); state.setProperty('/sort', 'title_asc'); state.setProperty('/page', 1); state.setProperty('/pageSize', 10); await loadPage(); } }),
            new sap.m.ToolbarSpacer(),
            pageSizeSel
          ]});
          list.setNoDataText('Keine Einträge gefunden.');
          const vbox = new sap.m.VBox({ width:'100%', items:[ new sap.m.Toolbar({ content:[ search, new sap.m.ToolbarSpacer(), sortSel ] }), infoBar, list, pager ] });
          vbox.setModel(state, 'state');
          // initial load
          setTimeout(loadPage, 0);
          return vbox;
        }

        // Board Tab (3 Spalten, Karten mit Chips)
        function makeBoard(){
          function statusNext(s){ if (s==='offen') return 'in_arbeit'; if (s==='in_arbeit') return 'abgeschlossen'; return 'abgeschlossen'; }
          function statusPrev(s){ if (s==='abgeschlossen') return 'in_arbeit'; if (s==='in_arbeit') return 'offen'; return 'offen'; }
          function cardTemplate(){
            const title = new sap.m.Title({ text:'{title}', level:'H5' });
            const prioChip = new sap.m.ObjectStatus({ text:'{priority}', state:{ path:'priority', formatter: fmt.prioState } });
            const statusChip = new sap.m.ObjectStatus({ text:{ path:'status', formatter: fmt.statusText }, state:{ path:'status', formatter: fmt.statusState } });
            const qaPrev = new sap.m.Button({ icon:'sap-icon://arrow-left', tooltip:'Status zurück', type:'Transparent', press: async (e)=>{
              const ctx = e.getSource().getBindingContext(); const o = ctx.getObject(); await updateTask(o.id, { status: statusPrev(o.status) });
            }});
            const qaNext = new sap.m.Button({ icon:'sap-icon://arrow-right', tooltip:'Status vor', type:'Transparent', press: async (e)=>{
              const ctx = e.getSource().getBindingContext(); const o = ctx.getObject(); await updateTask(o.id, { status: statusNext(o.status) });
            }});
            const qaDone = new sap.m.Button({ icon:'sap-icon://accept', tooltip:'Erledigen', type:'Accept', press: async (e)=>{
              const ctx = e.getSource().getBindingContext(); const o = ctx.getObject(); await updateTask(o.id, { status: 'abgeschlossen' });
            }});
            const actions = new sap.m.HBox({ items:[ qaPrev, qaNext, qaDone ] }).addStyleClass('sapUiTinyMarginBegin');
            const top = new sap.m.HBox({ justifyContent:'SpaceBetween', alignItems:'Center', items:[ title, new sap.m.HBox({ items:[ prioChip, new sap.m.Text({ text:'  ' }), statusChip, actions ] }) ] });
            const desc = new sap.m.Text({ text:'{description}', maxLines:3, wrapping:true });
            const tags = new sap.m.ObjectAttribute({ text: { path:'tags', formatter: function(v){
              if (Array.isArray(v)) return 'Tags: ' + v.join(', ');
              return v ? ('Tags: ' + v) : '';
            } } });
            const due = new sap.m.ObjectStatus({ text:{ path:'dueAt', formatter: fmt.dueText }, state:{ path:'dueAt', formatter: function(d){ return fmt.overdue(d)? 'Error':'None'; } } });
            const box = new sap.m.VBox({ width:'100%', items:[ top, new sap.m.ObjectStatus({ text:'' }), desc, tags, due ] }).addStyleClass('kanban-card__inner');
            const item = new sap.m.CustomListItem({ content:[ box ] });
            item.addStyleClass('kanban-card');
            return item;
          }
          function column(title, status){
            const statusKey = status;
            const countObj = new sap.m.ObjectNumber({ number:{
              parts:['/tasks'],
              formatter: function(tasks){ try{ return (tasks||[]).filter(t=>t.status===statusKey).length; }catch(_){ return 0; } }
            }, emphasized:true });
            const l = new sap.m.List({ mode:'None', inset:false, headerToolbar: new sap.m.Toolbar({ content:[ new sap.m.Title({ text:title }), new sap.m.ToolbarSpacer(), countObj ] }) });
            l.addStyleClass('board-column');
            l.setNoDataText('Keine Aufgaben');
            l.bindItems({ path:'/tasks',
              filters:[ new sap.ui.model.Filter('status', sap.ui.model.FilterOperator.EQ, status) ],
              template: cardTemplate()
            });
            // Drag & Drop group and visuals
            const dragInfo = new sap.ui.core.dnd.DragInfo({ groupName:'tasks', sourceAggregation:'items' });
            const dropInfo = new sap.ui.core.dnd.DropInfo({ groupName:'tasks', targetAggregation:'items' });
            if (typeof dropInfo.setDropPosition === 'function') {
              dropInfo.setDropPosition(sap.ui.core.dnd.DropPosition.Between);
            }
            if (typeof dropInfo.setDropLayout === 'function') {
              dropInfo.setDropLayout(sap.ui.core.dnd.DropLayout.Vertical);
            }
            if (typeof dropInfo.attachDragEnter === 'function') {
              dropInfo.attachDragEnter(function(){ l.addStyleClass('drop-hover'); });
            }
            if (typeof dropInfo.attachDragLeave === 'function') {
              dropInfo.attachDragLeave(function(){ l.removeStyleClass('drop-hover'); });
            }
            dropInfo.attachDrop(async function(oEvent){
              const dragged = oEvent.getParameter('draggedControl');
              const ctx = dragged && dragged.getBindingContext();
              if (!ctx) { return; }
              const t = ctx.getObject();
              const newStatus = status;
              if (t.status !== newStatus){ await updateTask(t.id, { status: newStatus }); sap.m.MessageToast.show('Verschoben: '+(t.title||'')); }
              l.removeStyleClass('drop-hover');
            });
            l.addDragDropConfig(dragInfo);
            l.addDragDropConfig(dropInfo);
            l.attachItemPress((ev)=>{ const t = ev.getParameter('listItem').getBindingContext().getObject(); openEditDialog(t); });
            return l;
          }
          const box = new sap.m.FlexBox({ alignItems:'Start', fitContainer:true, items:[
            new sap.m.VBox({ width:'33%', items:[ column('Offen','offen') ] }).addStyleClass('kanban-col'),
            new sap.m.VBox({ width:'34%', items:[ column('In Arbeit','in_arbeit') ] }).addStyleClass('kanban-col'),
            new sap.m.VBox({ width:'33%', items:[ column('Abgeschlossen','abgeschlossen') ] }).addStyleClass('kanban-col')
          ]});
          box.addStyleClass('kanban');
          return box;
        }

        // Kalender Tab (Datum auswählen, Items anzeigen)
        function makeCalendar(){
          const cal = new sap.ui.unified.Calendar();
          const list = new sap.m.List({ headerText:'Fällige Aufgaben & Events am gewählten Tag' });
          function updateForDate(d){
            const day = new Date(d.getFullYear(), d.getMonth(), d.getDate());
            const sameDay = (xDate)=>{
              try{
                const xd = new Date(xDate);
                return xd.getFullYear()===day.getFullYear() && xd.getMonth()===day.getMonth() && xd.getDate()===day.getDate();
              }catch(_){ return false; }
            };
            const tasks = (page.getModel().getProperty('/tasks')||[]).filter(t=> t.dueAt && sameDay(t.dueAt)).map(t=>({ type:'Aufgabe', title:t.title, time:t.dueAt }));
            const events = (page.getModel().getProperty('/events')||[]).filter(e=> e.date && sameDay(e.date)).map(e=>({ type:'Event', title:e.title, time:e.date }));
            const items = tasks.concat(events).sort((a,b)=> new Date(a.time)-new Date(b.time));
            const m = new sap.ui.model.json.JSONModel({ items });
            list.setModel(m, 'c');
          }
          cal.attachSelect(()=>{
            const s = cal.getSelectedDates()[0]; if (!s) return; updateForDate(s.getStartDate());
          });
          list.bindItems({ path:'c>/items', template: new sap.m.StandardListItem({ title:'{c>title}', description:'{c>type}', info:'{c>time}' }) });
          const calendarBox = new sap.m.VBox({ items:[ cal ] });
          calendarBox.setLayoutData(new sap.m.FlexItemData({ growFactor: 0 }));
          calendarBox.addStyleClass('calendar-box');

          const heroTitle = new sap.m.Title({
            text: '{= ${/events/0/title} ? "Highlight: " + ${/events/0/title} : "Aktionstage im Blick" }',
            level: 'H4'
          }).addStyleClass('sapUiTinyMarginBottom');
          const heroSubtitle = new sap.m.Text({
            text: '{= ${/events/0/date} ? "Nächster Termin: " + ${/events/0/date} : "Plane rechtzeitig Ressourcen und Team." }'
          }).addStyleClass('sapUiTinyMarginBottom');
          const heroHint = new sap.m.Text({ text: 'Tipp: Nutze den Kalender für Personaleinsatz und Kampagnenplanung.' });

          const heroContent = new sap.m.VBox({
            alignItems:'Start',
            justifyContent:'End',
            width:'100%',
            height:'100%',
            items:[
              new sap.m.ObjectStatus({ text:'Kalender Insight', state:'Success' }).addStyleClass('sapUiTinyMarginBottom'),
              heroTitle,
              heroSubtitle,
              heroHint
            ]
          }).addStyleClass('calendar-visual__content');

          const visualPanel = new sap.m.Panel({
            backgroundDesign:'Transparent',
            width:'100%',
            content:[ heroContent ]
          });
          visualPanel.setLayoutData(new sap.m.FlexItemData({ growFactor: 1 }));
          visualPanel.addStyleClass('calendar-visual');

          const topRow = new sap.m.FlexBox({
            width:'100%',
            wrap:'Wrap',
            alignItems:'Stretch',
            justifyContent:'SpaceBetween',
            items:[ calendarBox, visualPanel ]
          });
          topRow.addStyleClass('calendar-top');

          const vbox = new sap.m.VBox({ width:'100%', items:[ topRow, list ]});
          // init with today
          setTimeout(()=>{ const d=new Date(); cal.removeAllSelectedDates(); cal.addSelectedDate(new sap.ui.unified.DateRange({ startDate:d })); updateForDate(d); }, 0);
          return vbox;
        }

        // KPI Bar (grafisch) und Stats Bar (page-level)
        const kpiBar = new sap.m.Toolbar({ content:[
          new sap.m.ObjectNumber({ number:'{/tasksTotal}', unit:'gesamt', emphasized:true }),
          new sap.m.ToolbarSeparator(),
          new sap.m.ObjectNumber({ number:'{/countOffen}', unit:'offen', emphasized:false }),
          new sap.m.ToolbarSeparator(),
          new sap.m.ObjectNumber({ number:'{/countInArbeit}', unit:'in Arbeit', emphasized:false }),
          new sap.m.ToolbarSeparator(),
          new sap.m.ObjectNumber({ number:'{/countOverdue}', unit:'überfällig', emphasized:true, state:'Error' })
        ]});
        const statsBar = new sap.m.Toolbar({ content:[
          new sap.m.ObjectStatus({ text:'Offen: {/countOffen}', state:'None' }),
          new sap.m.ToolbarSeparator(),
          new sap.m.ObjectStatus({ text:'In Arbeit: {/countInArbeit}', state:'Information' }),
          new sap.m.ToolbarSeparator(),
          new sap.m.ObjectStatus({ text:'Abgeschlossen: {/countAbgeschlossen}', state:'Success' }),
          new sap.m.ToolbarSeparator(),
          new sap.m.ObjectStatus({ text:'Überfällig: {/countOverdue}', state:'Error' })
        ]});

        function openF1248(task){
          try{
            const doc = (task && task.sourceDoc && task.sourceDoc.id) || '';
            const url = 'https://me.sap.com/app/fiori/F1248?doc=' + encodeURIComponent(doc);
            window.open(url, '_blank');
          }catch(e){ console.error(e); sap.m.MessageToast.show('F1248 konnte nicht geöffnet werden'); }
        }

        function makeTaskCenter(){
          const prioSel = new sap.m.Select({ width:'11rem', selectedKey:'', items:[ new sap.ui.core.Item({ key:'', text:'Priorität: Alle' }), new sap.ui.core.Item({ key:'hoch', text:'Hoch' }), new sap.ui.core.Item({ key:'mittel', text:'Mittel' }), new sap.ui.core.Item({ key:'niedrig', text:'Niedrig' }) ] });
          const statusSel = new sap.m.Select({ width:'13rem', selectedKey:'offen', items:[ new sap.ui.core.Item({ key:'', text:'Status: Alle' }), new sap.ui.core.Item({ key:'offen', text:'Offen' }), new sap.ui.core.Item({ key:'in_arbeit', text:'In Arbeit' }), new sap.ui.core.Item({ key:'abgeschlossen', text:'Erledigt' }) ] });
          const typeSel = new sap.m.Select({ width:'15rem', selectedKey:'', items:[ new sap.ui.core.Item({ key:'', text:'Lieferart: Alle' }), new sap.ui.core.Item({ key:'STO', text:'Umlagerung (Lager/Filiale)' }), new sap.ui.core.Item({ key:'EXTERNAL', text:'Externer Partner' }), new sap.ui.core.Item({ key:'PROMO', text:'Aktion' }) ] });
          const tcToolbar = new sap.m.Toolbar({ content:[ new sap.m.Title({ text:'Task Center – Wareneingänge' }), new sap.m.ToolbarSpacer(), prioSel, statusSel, typeSel ] }).addStyleClass('sapUiSmallMarginBottom');

          const table = new sap.m.Table({
            inset:false,
            mode:'None',
            columns:[
              new sap.m.Column({ header:new sap.m.Label({ text:'Beleg' }) }),
              new sap.m.Column({ header:new sap.m.Label({ text:'Belegart' }) }),
              new sap.m.Column({ header:new sap.m.Label({ text:'Herkunft' }) }),
              new sap.m.Column({ header:new sap.m.Label({ text:'Warengruppe' }) }),
              new sap.m.Column({ header:new sap.m.Label({ text:'Aktion' }) }),
              new sap.m.Column({ header:new sap.m.Label({ text:'Stichtag' }) }),
              new sap.m.Column({ header:new sap.m.Label({ text:'Priorität' }) }),
              new sap.m.Column({ header:new sap.m.Label({ text:'Status' }) }),
              new sap.m.Column({ header:new sap.m.Label({ text:'Liefertermin' }) }),
              new sap.m.Column({ header:new sap.m.Label({ text:'Aktionen' }) })
            ]
          });

          function originText(t){ const tp=(t && t.sourceDoc && t.sourceDoc.type)||''; return tp==='STO' ? 'Lager/Filiale' : 'Externer Partner'; }
          function catText(t){ const s=Array.isArray(t&&t.tags)? t.tags.join(',').toLowerCase(): String((t&&t.tags)||'').toLowerCase(); if (s.includes('frische')) return 'Frische'; if (s.includes('tk')||s.includes('tiefkühl')||s.includes('kühl')) return 'Tiefkühlware'; return 'sonstige'; }
          function isPromo(t){ return (t && t.sourceDoc && t.sourceDoc.type)==='PROMO'; }
          function prioOrder(p){ return p==='hoch'?1:(p==='mittel'?2:3); }

          const template = new sap.m.ColumnListItem({
            cells:[
              new sap.m.ObjectIdentifier({ title:{ parts:['sourceDoc/id'], formatter:function(id){ return id||'—'; } }, text:'{title}' }),
              new sap.m.ObjectStatus({ text:{ parts:['sourceDoc/type'], formatter:function(t){ return t||'—'; } }, state:'None' }),
              new sap.m.Text({ text:{ path:'.', formatter: originText } }),
              new sap.m.ObjectStatus({ text:{ path:'.', formatter: catText }, state:{ path:'priority', formatter: fmt.prioState } }),
              new sap.m.ObjectStatus({ text:{ path:'.', formatter:function(t){ return isPromo(t)? 'Ja':'Nein'; } }, state:'None' }),
              new sap.m.Text({ text:{ path:'dueAt', formatter: fmt.dueText } }),
              new sap.m.ObjectStatus({ text:{ path:'priority' }, state:{ path:'priority', formatter: fmt.prioState } }),
              new sap.m.ObjectStatus({ text:{ path:'status', formatter: fmt.statusText }, state:{ path:'status', formatter: fmt.statusState } }),
              new sap.m.Text({ text:{ path:'expectedAt', formatter: fmt.dueText } }),
              new sap.m.HBox({ items:[
                new sap.m.Button({ text:'Öffnen', type:'Transparent', press:function(e){ const ctx=e.getSource().getBindingContext(); const t=ctx && ctx.getObject(); const docType=(t&&t.sourceDoc&&t.sourceDoc.type)||''; if (docType==='STO'){ openEditDialog(t); } else { openF1248(t); } } }),
                new sap.m.Button({ text:'Erledigt', type:'Success', visible:{ path:'.', formatter:function(t){ const docType=(t&&t.sourceDoc&&t.sourceDoc.type)||''; return docType==='STO' && (model.getProperty('/canPlanTasks') || model.getProperty('/canAccessAdmin')); } }, press: async function(e){ const t=e.getSource().getBindingContext().getObject(); await mockCompleteTask(t); } })
              ] })
            ]
          });

          function applyBinding(){
            const binding = table.getBinding('items'); if (!binding) return;
            const filters = [];
            filters.push(new sap.ui.model.Filter({ path:'processType', operator:'EQ', value1:'we' }));
            const p = prioSel.getSelectedKey(); if (p){ filters.push(new sap.ui.model.Filter({ path:'priority', operator:'EQ', value1:p })); }
            const s = statusSel.getSelectedKey(); if (s){ filters.push(new sap.ui.model.Filter({ path:'status', operator:'EQ', value1:s })); }
            const t = typeSel.getSelectedKey(); if (t==='STO'){ filters.push(new sap.ui.model.Filter({ path:'sourceDoc/type', operator:'EQ', value1:'STO' })); }
            else if (t==='PROMO'){ filters.push(new sap.ui.model.Filter({ path:'sourceDoc/type', operator:'EQ', value1:'PROMO' })); }
            else if (t==='EXTERNAL'){ filters.push(new sap.ui.model.Filter(function(o){ const tp=(o.getProperty('sourceDoc')||{}).type||''; return tp && tp!=='STO' && tp!=='PROMO'; })); }
            binding.filter(filters);
            binding.sort([ new sap.ui.model.Sorter('priority', false, null, function(a,b){ return prioOrder(a)-prioOrder(b); }), new sap.ui.model.Sorter('dueAt', false) ]);
          }

          table.bindItems({ path:'/tasks', template });
          table.attachEventOnce('updateFinished', applyBinding);
          prioSel.attachChange(applyBinding); statusSel.attachChange(applyBinding); typeSel.attachChange(applyBinding);

          return new sap.m.VBox({ width:'100%', items:[ tcToolbar, table ] });
        }

        const tagCloud = new sap.m.VBox({ items:[ new sap.m.Toolbar({ content:[ new sap.m.Title({ text:'Top Tags' }), new sap.m.ToolbarSpacer(), new sap.m.Button({ text:'Aktualisieren', icon:'sap-icon://synchronize', press: loadAdminOverview, tooltip:'Admin Überblick erneut laden' }) ] }), new sap.m.FlexBox({ alignItems:'Start', wrap:'Wrap', items:{ path:'/dashboard/tags', template: new sap.m.ObjectStatus({ text:'{tag} ({count})', state:'None' }).addStyleClass('sapUiSmallMargin') } }) ] });
        tagCloud.bindProperty('visible','/canAccessAdmin');
        const latestList = new sap.m.List({ headerText:'Neueste Aufgaben (Admin)', visible: { path:'/canAccessAdmin' } });
        latestList.bindItems({ path:'/dashboard/latest', template: new sap.m.StandardListItem({ title:'{title}', description:'{priority} • {status}', info: { path:'dueAt', formatter: fmt.dueText } }) });
        const adminPanel = new sap.m.Panel({ expandable:true, expanded:false, headerText:'Admin Dashboard', headerToolbar: new sap.m.Toolbar({ content:[ new sap.m.Title({ text:'Admin Dashboard' }), new sap.m.ToolbarSpacer(), new sap.m.Button({ text:'Demo-Daten hinzufügen', icon:'sap-icon://add-product', type:'Emphasized', press: async ()=>{
          if (!model.getProperty('/canAccessAdmin')) { sap.m.MessageToast.show('Keine Berechtigung.'); return; }
          if (!authToken) { sap.m.MessageToast.show('Bitte Token setzen'); return; }
          try {
            busy.open();
            const resp = await fetch(api + '/admin/seed', { method:'POST', headers: authHeaders(), body: JSON.stringify({ count:5 }) });
            const json = await resp.json();
            if (json && json.summary){ model.setProperty('/dashboard/summary', json.summary); }
            await loadTasks();
            await loadAdminOverview();
            sap.m.MessageToast.show('5 Demo-Aufgaben hinzugefügt');
          } catch(err){ sap.m.MessageToast.show('Seed fehlgeschlagen'); }
          finally { busy.close(); }
        } }), new sap.m.Button({ text:'Zurücksetzen', type:'Reject', icon:'sap-icon://reset', press: async ()=>{
          if (!model.getProperty('/canAccessAdmin')) { sap.m.MessageToast.show('Keine Berechtigung.'); return; }
          if (!authToken) { sap.m.MessageToast.show('Bitte Token setzen'); return; }
          try {
            busy.open();
            const confirm = confirm('Alle Aufgaben auf Ausgangszustand zurücksetzen?');
            if (!confirm) return;
            const resp = await fetch(api + '/admin/reset', { method:'POST', headers: authHeaders() });
            if (resp.ok){ await loadTasks(); await loadAdminOverview(); sap.m.MessageToast.show('Zurückgesetzt'); }
            else { sap.m.MessageToast.show('Zurücksetzen fehlgeschlagen'); }
          } catch(err){ sap.m.MessageToast.show('Zurücksetzen fehlgeschlagen'); }
          finally { busy.close(); }
        } }) ] }), content:[
          new sap.m.MessageStrip({ text:'Zusammenfassung: {= ${/dashboard/summary/total} + " Aufgaben • Überfällig: " + ${/dashboard/summary/overdue} + " • In 24h fällig: " + ${/dashboard/summary/dueSoon} }', type:'Information', showIcon:true, showCloseButton:false, visible:'{/canAccessAdmin}' }),
          new sap.m.MessageStrip({ text:'Keine Berechtigung für den Admin-Bereich. Bitte als Admin anmelden.', type:'Warning', showIcon:true, showCloseButton:false, visible:"{= !${/canAccessAdmin} }" }),
          new sap.m.HBox({ justifyContent:'SpaceAround', width:'100%', items:[
            new sap.m.VBox({ alignItems:'Center', items:[ new sap.ui.core.Icon({ src:'sap-icon://task', size:'2rem' }), new sap.m.ObjectNumber({ number:'{/dashboard/summary/total}', unit:'gesamt', emphasized:true }) ] }),
            new sap.m.VBox({ alignItems:'Center', items:[ new sap.ui.core.Icon({ src:'sap-icon://lateness', size:'2rem', color:'Critical' }), new sap.m.ObjectNumber({ number:'{/dashboard/summary/overdue}', unit:'überfällig', emphasized:true, state:'Error' }) ] }),
            new sap.m.VBox({ alignItems:'Center', items:[ new sap.ui.core.Icon({ src:'sap-icon://appointment-2', size:'2rem', color:'Information' }), new sap.m.ObjectNumber({ number:'{/dashboard/summary/dueSoon}', unit:'bald fällig', emphasized:false, state:'Information' }) ] })
          ]}).addStyleClass('sapUiMediumMarginBottom'),
          new sap.m.Panel({ expandable:false, headerText:'WE KPIs (Demo)', visible:'{/canAccessAdmin}', content:[
            new sap.m.HBox({ justifyContent:'SpaceAround', width:'100%', items:[
              new sap.m.VBox({ alignItems:'Center', items:[ new sap.ui.core.Icon({ src:'sap-icon://shipping-status', size:'2rem' }), new sap.m.ObjectNumber({ number:'{/adminDerived/weKPIs/total}', unit:'WE gesamt' }) ] }),
              new sap.m.VBox({ alignItems:'Center', items:[ new sap.ui.core.Icon({ src:'sap-icon://share-2', size:'2rem' }), new sap.m.ObjectNumber({ number:'{/adminDerived/weKPIs/sto}', unit:'Umlagerung' }) ] }),
              new sap.m.VBox({ alignItems:'Center', items:[ new sap.ui.core.Icon({ src:'sap-icon://supplier', size:'2rem' }), new sap.m.ObjectNumber({ number:'{/adminDerived/weKPIs/external}', unit:'extern' }) ] }),
              new sap.m.VBox({ alignItems:'Center', items:[ new sap.ui.core.Icon({ src:'sap-icon://marketing-campaign', size:'2rem' }), new sap.m.ObjectNumber({ number:'{/adminDerived/weKPIs/promo}', unit:'Promo' }) ] }),
              new sap.m.VBox({ alignItems:'Center', items:[ new sap.ui.core.Icon({ src:'sap-icon://fridge', size:'2rem' }), new sap.m.ObjectNumber({ number:'{/adminDerived/weKPIs/freshTk}', unit:'Frische/TK' }) ] })
            ]}).addStyleClass('sapUiSmallMarginBottom'),
            new sap.m.HBox({ justifyContent:'SpaceAround', width:'100%', items:[
              new sap.m.VBox({ alignItems:'Center', items:[ new sap.ui.core.Icon({ src:'sap-icon://accept', size:'2rem', color:'Positive' }), new sap.m.ObjectNumber({ number:'{/adminDerived/weKPIs/postedOk}', unit:'gebucht OK', emphasized:true, state:'Success' }) ] }),
              new sap.m.VBox({ alignItems:'Center', items:[ new sap.ui.core.Icon({ src:'sap-icon://error', size:'2rem', color:'Negative' }), new sap.m.ObjectNumber({ number:'{/adminDerived/weKPIs/postedErr}', unit:'Fehler', emphasized:true, state:'Error' }) ] })
            ]})
          ]}).addStyleClass('sapUiSmallMarginBottom'),
          new sap.m.Toolbar({ visible:'{/canAccessAdmin}', content:[ new sap.m.Title({ text:'Filter' }), new sap.m.ToolbarSpacer(), new sap.m.Text({ text:'Nur Frische/TK' }), new sap.m.Switch({ state:'{/adminFilters/weOnlyFresh}', change:function(e){ model.setProperty('/adminFilters/weOnlyFresh', e.getParameter('state')); computeAdminDerivations(); } }) ] }).addStyleClass('sapUiTinyMarginBottom'),
          new sap.m.Panel({ expandable:false, headerText:'Top überfällige WE (Demo)', visible:'{/canAccessAdmin}', content:[
            new sap.m.List({ items:{ path:'/adminDerived/topOverdueWE', template: new sap.m.ObjectListItem({
              title:'{title}',
              number: { path:'priority', formatter: function(p){ return p||''; } }, numberState:{ path:'priority', formatter: fmt.prioState },
              attributes:[
                new sap.m.ObjectAttribute({ text:{ parts:['sourceDoc/type','sourceDoc/id'], formatter: function(t,i){ return (t||'–') + (i? (' • '+i):''); } } }),
                new sap.m.ObjectAttribute({ text:{ path:'dueAt', formatter: fmt.dueText } })
              ],
              firstStatus: new sap.m.ObjectStatus({ text:{ path:'status', formatter: fmt.statusText }, state:{ path:'status', formatter: fmt.statusState } })
            }) } })
          ]}).addStyleClass('sapUiSmallMarginBottom'),
          new sap.m.Panel({ expandable:false, headerText:'Altersverteilung & Durchsatz (Demo)', visible:'{/canAccessAdmin}', content:[
            new sap.m.VBox({ width:'100%', items:[
              new sap.m.HBox({ alignItems:'Center', items:[ new sap.m.Text({ text:'≤ 1 Tag', width:'7rem' }), new sap.m.ProgressIndicator({ width:'100%', percentValue:{ parts:['/adminDerived/ageBuckets','/adminDerived/weKPIs/total'], formatter:function(a,t){ try{ const total=t||0; return total? Math.round(((a.d0_1||0)/total)*100):0; }catch(_){ return 0; } } }, displayValue:'{= ${/adminDerived/ageBuckets/d0_1} || 0 }', state:'None' }) ] }).addStyleClass('sapUiSmallMarginBottom'),
              new sap.m.HBox({ alignItems:'Center', items:[ new sap.m.Text({ text:'1–3 Tage', width:'7rem' }), new sap.m.ProgressIndicator({ width:'100%', percentValue:{ parts:['/adminDerived/ageBuckets','/adminDerived/weKPIs/total'], formatter:function(a,t){ try{ const total=t||0; return total? Math.round(((a.d1_3||0)/total)*100):0; }catch(_){ return 0; } } }, displayValue:'{= ${/adminDerived/ageBuckets/d1_3} || 0 }', state:'Information' }) ] }).addStyleClass('sapUiSmallMarginBottom'),
              new sap.m.HBox({ alignItems:'Center', items:[ new sap.m.Text({ text:'3–7 Tage', width:'7rem' }), new sap.m.ProgressIndicator({ width:'100%', percentValue:{ parts:['/adminDerived/ageBuckets','/adminDerived/weKPIs/total'], formatter:function(a,t){ try{ const total=t||0; return total? Math.round(((a.d3_7||0)/total)*100):0; }catch(_){ return 0; } } }, displayValue:'{= ${/adminDerived/ageBuckets/d3_7} || 0 }', state:'Warning' }) ] }).addStyleClass('sapUiSmallMarginBottom'),
              new sap.m.HBox({ alignItems:'Center', items:[ new sap.m.Text({ text:'> 7 Tage', width:'7rem' }), new sap.m.ProgressIndicator({ width:'100%', percentValue:{ parts:['/adminDerived/ageBuckets','/adminDerived/weKPIs/total'], formatter:function(a,t){ try{ const total=t||0; return total? Math.round(((a.d7p||0)/total)*100):0; }catch(_){ return 0; } } }, displayValue:'{= ${/adminDerived/ageBuckets/d7p} || 0 }', state:'Error' }) ] })
            ]}).addStyleClass('sapUiSmallMarginBottom'),
            new sap.m.HBox({ justifyContent:'SpaceAround', width:'100%', items:[
              new sap.m.VBox({ alignItems:'Center', items:[ new sap.ui.core.Icon({ src:'sap-icon://activities', size:'2rem' }), new sap.m.ObjectNumber({ number:'{/adminDerived/throughputToday}', unit:'abgeschlossen heute' }) ] }),
              new sap.m.VBox({ alignItems:'Center', items:[ new sap.ui.core.Icon({ src:'sap-icon://time-entry-request', size:'2rem' }), new sap.m.ObjectNumber({ number:'{/adminDerived/avgCycleTimeHours}', unit:'Ø Std. von Erstellung bis Abschluss' }) ] })
            ]})
          ]}).addStyleClass('sapUiSmallMarginBottom'),
          new sap.m.Panel({ expandable:false, headerText:'Statusverteilung', content:[ new sap.m.VBox({ width:'100%', items:[
            new sap.m.HBox({ alignItems:'Center', items:[ new sap.m.Text({ text:'Offen', width:'8rem' }), new sap.m.ProgressIndicator({ percentValue:{ parts:['/dashboard/summary/status'], formatter:function(s){ try{ const t=(s && (s.offen||0)+(s.in_arbeit||0)+(s.abgeschlossen||0))||0; return t? Math.round(((s.offen||0)/t)*100):0; }catch(_){ return 0; } } }, displayValue:'{= ${/dashboard/summary/status/offen} || 0 }', state:'None', width:'100%' }) ] }).addStyleClass('sapUiSmallMarginBottom'),
            new sap.m.HBox({ alignItems:'Center', items:[ new sap.m.Text({ text:'In Arbeit', width:'8rem' }), new sap.m.ProgressIndicator({ percentValue:{ parts:['/dashboard/summary/status'], formatter:function(s){ try{ const t=(s && (s.offen||0)+(s.in_arbeit||0)+(s.abgeschlossen||0))||0; return t? Math.round(((s.in_arbeit||0)/t)*100):0; }catch(_){ return 0; } } }, displayValue:'{= ${/dashboard/summary/status/in_arbeit} || 0 }', state:'Information', width:'100%' }) ] }).addStyleClass('sapUiSmallMarginBottom'),
            new sap.m.HBox({ alignItems:'Center', items:[ new sap.m.Text({ text:'Abgeschlossen', width:'8rem' }), new sap.m.ProgressIndicator({ percentValue:{ parts:['/dashboard/summary/status'], formatter:function(s){ try{ const t=(s && (s.offen||0)+(s.in_arbeit||0)+(s.abgeschlossen||0))||0; return t? Math.round(((s.abgeschlossen||0)/t)*100):0; }catch(_){ return 0; } } }, displayValue:'{= ${/dashboard/summary/status/abgeschlossen} || 0 }', state:'Success', width:'100%' }) ] })
          ]}) ] }).addStyleClass('sapUiSmallMarginBottom'),
          tagCloud,
          latestList
        ]});

        // Tabs Container
        const adminTabContent = [
          adminPanel
        ];
        const tabs = new sap.m.IconTabBar({ expandable:false, items:[
          new sap.m.IconTabFilter({ key:'tasks', text:'Aufgaben', count: '{/tasksCount}', icon:'sap-icon://task', content:[ toolbar, chipBar, kpiBar, prioLegend, statsBar, new sap.m.ObjectStatus({ text:'Überfällige Aufgaben werden rot markiert.', state:'None' }), list ] }),
          new sap.m.IconTabFilter({ key:'updates', text:'Updates', count: '{/updatesCount}', icon:'sap-icon://message-information', content:[ makeSimpleTab({ path:'/updates', title:'Updates', desc:'content', info:'date', detailBuilder: buildUpdateDetailContent, titleProp:'title', action:'update' }) ] }),
          new sap.m.IconTabFilter({ key:'guides', text:'Anleitungen', count: '{/guidesCount}', icon:'sap-icon://hint', content:[ makeSimpleTab({ path:'/guides', title:'Anleitungen', desc:'description', detailBuilder: buildGuideDetailContent, titleProp:'title', info:'duration', action:'guide' }) ] }),
          new sap.m.IconTabFilter({ key:'events', text:'Aktionstage', count: '{/eventsCount}', icon:'sap-icon://calendar', content:[ makeSimpleTab({ path:'/events', title:'Aktionstage', desc:'description', info:'date', detailBuilder: buildEventDetailContent, titleProp:'title', action:'event' }) ] }),
          new sap.m.IconTabFilter({ key:'board', text:'Board', icon:'sap-icon://kanban', content:[ makeBoard() ] }),
          new sap.m.IconTabFilter({ key:'calendar', text:'Kalender', icon:'sap-icon://appointment-2', content:[ makeCalendar() ] }),
          new sap.m.IconTabFilter({ key:'taskcenter', text:'Task Center', icon:'sap-icon://shipping-status', content:[ makeTaskCenter() ] }),
          new sap.m.IconTabFilter({ key:'admin', text:'Admin', icon:'sap-icon://action-settings', content: adminTabContent, visible:'{/canAccessAdmin}' })
        ]});

        // Apply admin settings after UI build
        (function applyAdmin(){
          if (adminSettings && adminSettings.theme){ try{ sap.ui.getCore().applyTheme(adminSettings.theme); }catch(_){} }
          if (adminSettings && adminSettings.notifyMs){ startNotifyInterval(adminSettings.notifyMs); } else { startNotifyInterval(60000); }
          if (document.body && !document.body.classList.contains('sapUiSizeCompact')){ /* leave as-is; admin can toggle */ }
        })();

        // Assemble page (use sap.m.Bar header to ensure compatibility)
        page.addContent(tabs);
        app.addPage(page);

        // Bind model
        app.setModel(model);
        page.setModel(model);
        list.setModel(model);

        // Initial server-side load for tasks
        await loadTasks();

        // App
        app.placeAt('content');
      });
    </script>
    <script src="./assets/data.js"></script>
  </body>
</html>
